<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Despesa com Pessoal MG</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse para CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        /* ==================== VARIÁVEIS DE CORES ==================== */
        :root {
            --primary-dark: #1A5276;
            --primary-darker: #0E2F44;
            --accent-blue: #3498DB;
            --accent-bright: #2980B9;
            --background-light: #F2F4F7;
            --success-green: #27AE60;
            --warning-yellow: #F39C12;
            --info-blue: #17A589;
            --secondary-purple: #8E44AD;
            --secondary-orange: #E67E22;
            --secondary-teal: #16A085;
            --danger-red: #E74C3C;
        }
        
        /* ==================== ESTILOS GERAIS ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-light);
            padding-top: 20px;
            padding-bottom: 40px;
        }
        
        /* Remover scroll do body */
        body.no-scroll {
            overflow: hidden;
        }
        
        /* Espaçamento no topo da página */
        .page-top-spacing {
            margin-top: 20px;
        }
        
        /* ==================== HEADER PRINCIPAL REMOVIDO ==================== */
        
        /* ==================== DATA DE ATUALIZAÇÃO ==================== */
        #data-atualizacao-container {
            margin-top: 20px;
            margin-bottom: 25px;
            animation: fadeIn 0.5s ease-in;
        }
        
        #data-atualizacao-container .bg-light {
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            padding: 10px 20px;
            min-width: 300px;
        }
        
        #data-atualizacao-container .bg-light:hover {
            background-color: #F2F4F7 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #data-ultima-atualizacao {
            font-size: 1rem;
        }
        
        /* ==================== FILTROS ==================== */
        .filter-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid var(--accent-blue);
        }
        
        .filter-label {
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 6px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 13px;
            transition: all 0.3s ease;
            height: 42px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.15);
        }
        
        /* ==================== CARDS DE MÉTRICAS ==================== */
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px 15px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
            border-top: 4px solid var(--accent-blue);
            transition: all 0.3s ease;
            height: 100%;
            position: relative;
            cursor: default;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
        
        .metric-card.primary {
            border-top-color: var(--primary-dark);
        }
        
        .metric-card.success {
            border-top-color: var(--success-green);
        }
        
        .metric-card.warning {
            border-top-color: var(--warning-yellow);
        }
        
        .metric-card.info {
            border-top-color: var(--info-blue);
        }
        
        .metric-card.purple {
            border-top-color: var(--secondary-purple);
        }
        
        .metric-card.orange {
            border-top-color: var(--secondary-orange);
        }
        
        .metric-card.danger {
            border-top-color: var(--danger-red);
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-dark);
            margin: 8px 0;
            line-height: 1;
        }
        
        .metric-label {
            font-size: 12px;
            color: var(--primary-darker);
            font-weight: 600;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .metric-change {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 15px;
            display: inline-block;
        }
        
        .metric-change.positive {
            background-color: rgba(39, 174, 96, 0.1);
            color: var(--success-green);
        }
        
        .metric-change.warning {
            background-color: rgba(243, 156, 18, 0.1);
            color: var(--warning-yellow);
        }
        
        .metric-change.danger {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-red);
        }
        
        /* ==================== CONTAINER DE GRÁFICOS ==================== */
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
            height: 100%;
            min-height: 280px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--background-light);
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-dark);
            margin: 0;
        }
        
        .chart-wrapper {
            position: relative;
            height: 220px;
            width: 100%;
        }
        
        /* ==================== TABELAS ==================== */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
            margin-bottom: 30px;
        }
        
        .table-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-darker) 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .table-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }
        
        .table-badge {
            background: var(--accent-blue);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Container para tabela com cabeçalho fixo */
        .table-fixed-header-container {
            position: relative;
            max-height: 500px;
            overflow: auto;
            padding: 0;
        }
        
        /* Cabeçalho fixo para todas as tabelas */
        .table-fixed-header-container table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f8f9fa !important;
        }
        
        .table-fixed-header-container table thead th {
            background-color: #f8f9fa !important;
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        .table-responsive {
            padding: 0;
            overflow-x: auto;
        }
        
        .table {
            margin: 0;
            width: 100%;
            font-size: 13px;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .table thead th {
            background-color: #f8f9fa !important;
            color: var(--primary-dark);
            font-weight: 600;
            border: none;
            padding: 12px 10px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
            position: sticky;
            top: 0;
            z-index: 20;
            white-space: nowrap;
        }
        
        .sort-icon {
            opacity: 0.5;
            margin-left: 4px;
            font-size: 9px;
            transition: opacity 0.2s ease;
        }
        
        .table thead th:hover {
            background-color: #f1f3f5 !important;
        }
        
        .table thead th:hover .sort-icon {
            opacity: 1;
        }
        
        .table thead th.sorted-asc .sort-icon,
        .table thead th.sorted-desc .sort-icon {
            opacity: 1;
        }
        
        .table thead th.sorted-asc .sort-icon::after {
            content: "↑";
        }
        
        .table thead th.sorted-desc .sort-icon::after {
            content: "↓";
        }
        
        .table tbody tr {
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .table tbody tr:hover {
            background-color: rgba(26, 82, 118, 0.04);
        }
        
        .table tbody td {
            padding: 12px 10px;
            vertical-align: middle;
            font-size: 13px;
        }
        
        /* Estilos específicos para valores monetários SEM ABREVIAÇÃO */
        .valor-monetario {
            font-weight: 600;
            text-align: right;
            white-space: nowrap;
            font-size: 13px;
        }
        
        .valor-positivo {
            color: var(--success-green);
        }
        
        .valor-negativo {
            color: var(--danger-red);
        }
        
        /* ==================== BOTÕES ==================== */
        .btn-primary-custom {
            background: linear-gradient(to right, var(--accent-blue), var(--accent-bright));
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 13px;
            color: white;
            cursor: pointer;
        }
        
        .btn-primary-custom:hover {
            background: linear-gradient(to right, var(--accent-bright), var(--accent-blue));
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
            color: white;
        }
        
        .btn-secondary-custom {
            background: white;
            border: 2px solid var(--primary-dark);
            color: var(--primary-dark);
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 13px;
            cursor: pointer;
        }
        
        .btn-secondary-custom:hover {
            background-color: var(--primary-dark);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26, 82, 118, 0.15);
        }
        
        .btn-export {
            background: white;
            border: 2px solid var(--primary-dark);
            color: var(--primary-dark);
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .btn-export:hover {
            background: var(--primary-dark);
            color: white;
            transform: translateY(-1px);
            text-decoration: none;
        }
        
        /* ==================== MENU DE NAVEGAÇÃO ==================== */
        .nav-tabs-container {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
        }
        
        .nav-tabs {
            border: none;
            gap: 4px;
            flex-wrap: nowrap;
            overflow-x: auto;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 6px;
            padding: 10px 15px;
            font-weight: 600;
            color: var(--primary-dark);
            transition: all 0.3s ease;
            font-size: 13px;
            white-space: nowrap;
            cursor: pointer;
        }
        
        .nav-tabs .nav-link:hover {
            background-color: rgba(26, 82, 118, 0.05);
            color: var(--accent-blue);
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-darker) 100%);
            color: white;
        }
        
        /* ==================== AÇÕES ==================== */
        .actions-container {
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .export-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        /* ==================== LOADING OVERLAY ==================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(26, 82, 118, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        /* ==================== RODAPÉ DA TABELA ==================== */
        .table-total-row {
            background-color: #f8f9fa !important;
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .table-total-row td {
            border-top: 2px solid #dee2e6 !important;
        }

        /* ==================== BARRAS DE PROGRESSO ==================== */
        .progress-limite {
            height: 20px;
            border-radius: 10px;
            background-color: #e9ecef;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-bar-limite {
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .progress-bar-limite.safe {
            background-color: var(--success-green);
        }
        
        .progress-bar-limite.warning {
            background-color: var(--warning-yellow);
        }
        
        .progress-bar-limite.danger {
            background-color: var(--danger-red);
        }
        
        .limite-info {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-top: 3px;
            color: var(--primary-darker);
        }
        
        /* ==================== CARDS DE LIMITES ==================== */
        .limite-card {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .limite-card.safe {
            border-top: 4px solid var(--success-green);
        }
        
        .limite-card.warning {
            border-top: 4px solid var(--warning-yellow);
        }
        
        .limite-card.danger {
            border-top: 4px solid var(--danger-red);
        }
        
        .limite-card .valor {
            font-size: 20px;
            font-weight: 700;
            margin: 8px 0;
        }
        
        .limite-card .porcentagem {
            font-size: 24px;
            font-weight: 700;
            margin: 8px 0;
        }
        
        .limite-card .label {
            font-size: 12px;
            color: var(--primary-darker);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        /* ==================== RODAPÉ ==================== */
        footer {
            background: var(--primary-darker);
            color: white;
            padding: 20px 0;
            margin-top: 40px;
            text-align: center;
        }
        
        .footer-content {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .footer-content a {
            color: var(--accent-blue);
            text-decoration: none;
        }
        
        .footer-content a:hover {
            text-decoration: underline;
        }
        
        /* ==================== RESPONSIVIDADE ==================== */
        @media (max-width: 768px) {
            body {
                padding-top: 10px;
                padding-bottom: 20px;
            }
            
            .metric-value {
                font-size: 20px;
            }
            
            .actions-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .export-buttons {
                width: 100%;
                justify-content: flex-start;
            }
            
            .nav-tabs .nav-link {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .chart-wrapper {
                height: 200px;
            }
            
            .table-responsive {
                font-size: 12px;
            }
            
            .table thead th,
            .table tbody td {
                padding: 8px 6px;
                font-size: 11px;
            }
            
            .pagination-container {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            
            .btn-primary-custom,
            .btn-secondary-custom {
                padding: 8px 15px;
                font-size: 12px;
            }
            
            .limite-card .valor {
                font-size: 18px;
            }
            
            .limite-card .porcentagem {
                font-size: 20px;
            }
            
            #data-atualizacao-container .bg-light {
                min-width: auto;
                padding: 8px 15px;
            }
        }
        
        @media (max-width: 576px) {
            .filter-container .row > div {
                margin-bottom: 10px;
            }
            
            .chart-container {
                min-height: 240px;
            }
            
            .chart-wrapper {
                height: 180px;
            }
        }
        
        /* ==================== ESTILOS ADICIONAIS ==================== */
        .card-stats {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            height: 100%;
        }
        
        /* Animação */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <!-- ==================== MENU DE NAVEGAÇÃO ==================== -->
    <div class="container page-top-spacing">
        <div class="nav-tabs-container">
            <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dashboard1-tab" data-bs-toggle="tab" data-bs-target="#dashboard1" type="button" role="tab">
                        <i class="fas fa-chart-bar me-2"></i>Visão Geral
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="dashboard2-tab" data-bs-toggle="tab" data-bs-target="#dashboard2" type="button" role="tab">
                        <i class="fas fa-calendar-alt me-2"></i>Evolução Mensal
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="dashboard3-tab" data-bs-toggle="tab" data-bs-target="#dashboard3" type="button" role="tab">
                        <i class="fas fa-balance-scale me-2"></i>Limites da LRF
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="dashboard4-tab" data-bs-toggle="tab" data-bs-target="#dashboard4" type="button" role="tab">
                        <i class="fas fa-download me-2"></i>Downloads
                    </button>
                </li>
            </ul>
        </div>

        <!-- ==================== DATA DE ATUALIZAÇÃO (CENTRALIZADA) ==================== -->
        <div class="text-center my-4" id="data-atualizacao-container">
            <div class="d-inline-block bg-light p-3 rounded shadow-sm">
                <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>Última atualização dos dados:
                </small>
                <div id="data-ultima-atualizacao" class="fw-bold text-primary d-inline-block ms-2">
                    Carregando...
                </div>
            </div>
        </div>

        <!-- ==================== LOADING OVERLAY ==================== -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="text-center">
                <div class="spinner"></div>
                <p class="mt-3 text-primary fw-bold">Carregando dados...</p>
            </div>
        </div>

        <!-- ==================== CONTEÚDO DAS ABAS ==================== -->
        <div class="tab-content" id="dashboardTabsContent">
            
            <!-- ==================== DASHBOARD 1: VISÃO GERAL ==================== -->
            <div class="tab-pane fade show active" id="dashboard1" role="tabpanel">
                
                <!-- Filtros Dashboard 1 -->
                <div class="filter-container">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="anoDashboard1" class="form-label filter-label">Ano</label>
                                <select class="form-select" id="anoDashboard1">
                                    <option value="">2025</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="mesDashboard1" class="form-label filter-label">Mês</label>
                                <select class="form-select" id="mesDashboard1">
                                    <option value="">Todos os meses</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex gap-3 flex-wrap">
                                <button class="btn-primary-custom" id="aplicarFiltros">
                                    <i class="fas fa-filter me-2"></i>Aplicar Filtros
                                </button>
                                <button class="btn-secondary-custom" id="limparFiltros">
                                    <i class="fas fa-redo me-2"></i>Limpar Filtros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cards de Estatísticas Dashboard 1 -->
                <div class="row mb-4" id="summaryCards">
                    <!-- Cards serão carregados aqui -->
                </div>

                <!-- Gráficos Dashboard 1 -->
                <div class="row mb-4">
                    <div class="col-md-6 col-12">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h4 class="chart-title">Distribuição da Despesa</h4>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="chartDistribuicao"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-12">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h4 class="chart-title">Despesa com Pessoal Ativo</h4>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="chartAtivoDetalhado"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ações Dashboard 1 -->
                <div class="actions-container mb-4">
                    <div class="export-buttons">
                        <button class="btn-export" id="exportCSVDashboard1">
                            <i class="fas fa-file-csv me-2"></i> Exportar CSV
                        </button>
                        <button class="btn-export" id="printDashboard1">
                            <i class="fas fa-print me-2"></i> Imprimir
                        </button>
                    </div>
                </div>

                <!-- Tabela Dashboard 1 - RESUMO -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Despesa com Pessoal - Resumo</h3>
                        <div class="d-flex align-items-center gap-3 ms-auto">
                            <span class="table-badge" id="resumoCountDashboard1">0 registros</span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="resumoTable">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th class="text-end">Valor (R$)</th>
                                    <th class="text-end">% do Total</th>
                                    <th class="text-end">Média Mensal</th>
                                </tr>
                            </thead>
                            <tbody id="resumoTableBody">
                                <!-- Dados serão carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
            </div> <!-- Fim Dashboard 1 -->

            <!-- ==================== DASHBOARD 2: EVOLUÇÃO MENSAL ==================== -->
            <div class="tab-pane fade" id="dashboard2" role="tabpanel">
                
                <!-- Filtros Dashboard 2 -->
                <div class="filter-container">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="anoDashboard2" class="form-label filter-label">Ano</label>
                                <select class="form-select" id="anoDashboard2">
                                    <option value="">Todos os anos</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoriaDashboard2" class="form-label filter-label">Categoria</label>
                                <select class="form-select" id="categoriaDashboard2">
                                    <option value="total">Despesa Total</option>
                                    <option value="bruta">Despesa Bruta</option>
                                    <option value="liquida">Despesa Líquida</option>
                                    <option value="ativo">Pessoal Ativo</option>
                                    <option value="inativo">Inativos/Pensionistas</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex gap-3 flex-wrap">
                                <button class="btn-primary-custom" id="aplicarFiltrosDashboard2">
                                    <i class="fas fa-filter me-2"></i>Aplicar Filtros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Evolução -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h4 class="chart-title">Evolução Mensal da Despesa</h4>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="toggleAccumulated">
                                    <label class="form-check-label" for="toggleAccumulated" style="font-size: 12px;">
                                        Acumulado
                                    </label>
                                </div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="chartEvolucao"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ações Dashboard 2 -->
                <div class="actions-container mb-4">
                    <div class="export-buttons">
                        <button class="btn-export" id="exportCSVDashboard2">
                            <i class="fas fa-file-csv me-2"></i> Exportar CSV
                        </button>
                        <button class="btn-export" id="printDashboard2">
                            <i class="fas fa-print me-2"></i> Imprimir
                        </button>
                    </div>
                </div>

                <!-- Tabela de Evolução Mensal -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Evolução Mensal da Despesa</h3>
                        <div class="d-flex align-items-center gap-3 ms-auto">
                            <span class="table-badge" id="resumoCountDashboard2">0 registros</span>
                        </div>
                    </div>
                    <div class="table-fixed-header-container">
                        <table class="table table-hover" id="evolucaoTable">
                            <thead>
                                <tr>
                                    <th>Mês</th>
                                    <th class="text-end">Despesa Bruta</th>
                                    <th class="text-end">Despesa Líquida</th>
                                    <th class="text-end">Pessoal Ativo</th>
                                    <th class="text-end">Inativos/Pensionistas</th>
                                    <th class="text-end">Variação Mês Anterior</th>
                                </tr>
                            </thead>
                            <tbody id="evolucaoTableBody">
                                <!-- Dados serão carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
            </div> <!-- Fim Dashboard 2 -->

            <!-- ==================== DASHBOARD 3: LIMITES DA LRF ==================== -->
            <div class="tab-pane fade" id="dashboard3" role="tabpanel">
                
                <!-- Filtros Dashboard 3 -->
                <div class="filter-container">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="periodoLRF" class="form-label filter-label">Período de 12 Meses</label>
                                <select class="form-select" id="periodoLRF">
                                    <option value="">Selecione um período</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cards de Limites -->
                <div class="row mb-4">
                    <div class="col-md-4 col-12">
                        <div class="limite-card safe" id="limiteLegalCard">
                            <div class="label">LIMITE LEGAL</div>
                            <div class="porcentagem" id="limiteLegalPercentual">49.00%</div>
                            <div class="valor" id="limiteLegalValor">R$ 0,00</div>
                            <div class="limite-info">
                                <span>Máximo permitido</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-12">
                        <div class="limite-card warning" id="limitePrudencialCard">
                            <div class="label">LIMITE PRUDENCIAL</div>
                            <div class="porcentagem" id="limitePrudencialPercentual">46.55%</div>
                            <div class="valor" id="limitePrudencialValor">R$ 0,00</div>
                            <div class="limite-info">
                                <span>Recomendação</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-12">
                        <div class="limite-card danger" id="limiteAlertaCard">
                            <div class="label">LIMITE DE ALERTA</div>
                            <div class="porcentagem" id="limiteAlertaPercentual">44.10%</div>
                            <div class="valor" id="limiteAlertaValor">R$ 0,00</div>
                            <div class="limite-info">
                                <span>Atenção necessária</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Barra de Progresso -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h4 class="chart-title">Despesa com Pessoal em Relação à RCL</h4>
                                <span class="badge bg-primary" id="despesaAtualPercentual">0%</span>
                            </div>
                            <div class="p-4">
                                <div class="progress-limite">
                                    <div class="progress-bar-limite" id="progressBar" style="width: 0%"></div>
                                </div>
                                <div class="limite-info">
                                    <span>0%</span>
                                    <span>Limite de Alerta: <span id="limiteAlertaValorLabel">44.10%</span></span>
                                    <span>Limite Prudencial: <span id="limitePrudencialValorLabel">46.55%</span></span>
                                    <span>Limite Legal: <span id="limiteLegalValorLabel">49.00%</span></span>
                                    <span>100%</span>
                                </div>
                                
                                <div class="mt-4">
                                    <h5>Informações da RCL</h5>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label filter-label">Receita Corrente Líquida (RCL)</label>
                                                <div class="valor-monetario valor-positivo" id="rclTotal">R$ 0,00</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label filter-label">Despesa com Pessoal Executada</label>
                                                <div class="valor-monetario" id="despesaExecutada">R$ 0,00</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Limites -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Apuração do Cumprimento do Limite Legal</h3>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover" id="limitesTable">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th class="text-end">Valor (R$)</th>
                                    <th class="text-end">% sobre a RCL</th>
                                </tr>
                            </thead>
                            <tbody id="limitesTableBody">
                                <!-- Dados serão carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
            </div> <!-- Fim Dashboard 3 -->

            <!-- ==================== DASHBOARD 4: DOWNLOADS ==================== -->
            <div class="tab-pane fade" id="dashboard4" role="tabpanel">
                
<!-- Download por Quadrimestre -->
<div class="filter-container">
    <div class="row align-items-center"> <!-- Adicionar align-items-center aqui -->
        <div class="col-md-4 col-12">
            <div class="mb-3">
                <label for="anoDownload" class="form-label filter-label">Ano</label>
                <select class="form-select" id="anoDownload">
                    <option value="">Selecione um ano</option>
                </select>
            </div>
        </div>
        <div class="col-md-4 col-12">
            <div class="mb-3">
                <label for="quadrimestreDownload" class="form-label filter-label">Quadrimestre</label>
                <select class="form-select" id="quadrimestreDownload">
                    <option value="1">1º Quadrimestre (Jan-Abr)</option>
                    <option value="2">2º Quadrimestre (Mai-Ago)</option>
                    <option value="3">3º Quadrimestre (Set-Dez)</option>
                </select>
            </div>
        </div>
        <div class="col-md-4 col-12 d-flex align-items-end">
            <button class="btn-primary-custom w-100" id="downloadQuadrimestreCSV">
                <i class="fas fa-download me-2"></i>Baixar Quadrimestre
            </button>
        </div>
    </div>
</div>

                <!-- Informações sobre os dados -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Informações sobre os Dados</h3>
                    </div>
                    <div class="p-4">
                        <div class="row">
                            <div class="col-md-6 col-12 mb-3">
                                <div class="card-stats">
                                    <i class="fas fa-database fa-3x mb-3" style="color: var(--primary-dark);"></i>
                                    <h4>Fonte dos Dados</h4>
                                    <p class="text-muted" style="font-size: 13px;">Dados atualizados automaticamente do GitHub</p>
                                    <div class="mt-3">
                                        <button class="btn-export w-100 d-block text-decoration-none" id="atualizarDadosGitHub">
                                            <i class="fas fa-sync-alt me-2"></i>Forçar Atualização
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-12">
                                <div class="card-stats">
                                    <i class="fas fa-external-link-alt fa-3x mb-3" style="color: var(--primary-dark);"></i>
                                    <h4>Portal de Dados Abertos</h4>
                                    <p class="text-muted" style="font-size: 13px;">Acesse o portal oficial de dados abertos de Minas Gerais</p>
                                    <div class="mt-3">
                                        <a href="https://dados.mg.gov.br/" 
                                           target="_blank" 
                                           class="btn-export w-100 d-block text-decoration-none">
                                            <i class="fas fa-external-link-alt me-2"></i>Acessar Portal
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h5 class="mb-3">Estrutura dos Arquivos CSV</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Arquivo</th>
                                            <th>Descrição</th>
                                            <th>Período de Atualização</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>despesa_pessoal_mensal.csv</strong></td>
                                            <td>Dados mensais de despesa com pessoal</td>
                                            <td>Quadrimestral</td>
                                        </tr>
                                        <tr>
                                            <td><strong>limites_lrf.csv</strong></td>
                                            <td>Limites da Lei de Responsabilidade Fiscal por período de 12 meses</td>
                                            <td>Quadrimestral</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Atualização Automática:</strong> Os dados são atualizados automaticamente quando novos arquivos são adicionados ao repositório GitHub. 
                                Os relatórios são gerados quadrimestralmente.
                            </div>
                            
                            <div class="alert alert-success mt-2">
                                <i class="fas fa-balance-scale me-2"></i>
                                <strong>Conformidade Legal:</strong> Os dados seguem as disposições da Lei Complementar nº 101/2000 (LRF) e são publicados conforme exigências do RGF.
                            </div>
                        </div>
                    </div>
                </div>
                
            </div> <!-- Fim Dashboard 4 -->
        </div>
    </div>

    <!-- ==================== SCRIPTS ==================== -->
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==================== VARIÁVEIS GLOBAIS ====================
        let despesaMensalData = [];
        let limitesLRFData = [];
        let dashboardData = {};
        let chartDistribuicao = null;
        let chartAtivoDetalhado = null;
        let chartEvolucao = null;
        let currentChartCategory = 'total';

        // ==================== FUNÇÃO PARA BUSCAR DATA DO GITHUB ====================
        async function fetchGitHubLastUpdate() {
            const GITHUB_OWNER = 'transparencia-mg';
            const GITHUB_REPO = 'despesa-pessoal-mg';
            const apiUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/commits`;
            
            try {
                console.log('Buscando última atualização do GitHub...');
                
                const response = await fetch(apiUrl, {
                    headers: {
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const commits = await response.json();
                
                if (commits && commits.length > 0) {
                    const lastCommit = commits[0];
                    const lastUpdate = new Date(lastCommit.commit.committer.date);
                    
                    // Formatar data em português
                    const formattedDate = formatDateToPortuguese(lastUpdate);
                    
                    // Atualizar elemento
                    const updateElement = document.getElementById('data-ultima-atualizacao');
                    if (updateElement) {
                        updateElement.textContent = formattedDate;
                        updateElement.innerHTML = `<i class="fas fa-check-circle text-success me-1"></i>${formattedDate}`;
                    }
                    
                    return lastUpdate;
                }
            } catch (error) {
                console.error('Erro ao buscar data do GitHub:', error);
                
                // Fallback: mostrar data atual
                const updateElement = document.getElementById('data-ultima-atualizacao');
                if (updateElement) {
                    const today = new Date();
                    updateElement.textContent = formatDateToPortuguese(today) + ' (aprox.)';
                    updateElement.innerHTML = `<i class="fas fa-exclamation-triangle text-warning me-1"></i>${formatDateToPortuguese(today)} <small class="text-muted">(aprox.)</small>`;
                }
            }
        }

        // Função para formatar data em português
        function formatDateToPortuguese(date) {
            return date.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: 'long',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ==================== FUNÇÕES DE UTILIDADE ====================
        
        // Função para converter valores brasileiros para números
        function converterValor(valor) {
            if (!valor || valor === '-' || valor.trim() === '-') return 0;
            
            let valorStr = String(valor).trim();
            valorStr = valorStr.replace(/\./g, '').replace(',', '.');
            valorStr = valorStr.replace(/\s/g, '');
            
            const num = parseFloat(valorStr);
            return isNaN(num) ? 0 : num;
        }
        
        // Função para formatar valores monetários SEM ABREVIAÇÃO
        function formatarMoeda(valor) {
            if (valor === undefined || valor === null || valor === 0) return 'R$ 0,00';
            
            const num = typeof valor === 'string' ? parseFloat(valor) : valor;
            
            if (isNaN(num)) return 'R$ 0,00';
            
            // Formatar sem abreviação: R$ 5.920.545,00
            return `R$ ${num.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        }
        
        // Função para formatar porcentagem
        function formatarPorcentagem(valor) {
            if (valor === undefined || valor === null) return '0%';
            return `${valor.toFixed(2)}%`;
        }
        
        // Função para converter formato de mês
        function formatarMesAno(mesAno) {
            if (!mesAno) return '';
            
            const mesAnoNormalizado = mesAno.includes('-') ? mesAno.replace('-', '_') : mesAno;
            const partes = mesAnoNormalizado.split('_');
            
            if (partes.length >= 2) {
                const mes = partes[0];
                const ano = '20' + partes[1];
                
                const meses = {
                    'jan': 'Jan', 'fev': 'Fev', 'mar': 'Mar', 'abr': 'Abr',
                    'mai': 'Mai', 'jun': 'Jun', 'jul': 'Jul', 'ago': 'Ago',
                    'set': 'Set', 'out': 'Out', 'nov': 'Nov', 'dez': 'Dez'
                };
                
                return `${meses[mes] || mes}/${ano}`;
            }
            return mesAno;
        }
        
        // Função para converter formato de período LRF
        function formatarPeriodoLRF(periodo) {
            if (!periodo) return '';
            
            const partes = periodo.split('_a_');
            if (partes.length === 2) {
                const inicio = formatarMesAno(partes[0]);
                const fim = formatarMesAno(partes[1]);
                return `${inicio} a ${fim}`;
            }
            
            return periodo.replace(/_/g, '/').replace('a/', ' a ');
        }
        
        // Função para obter número do mês
        function getMesNumero(mesAbrev) {
            const meses = {
                'jan': 1, 'fev': 2, 'mar': 3, 'abr': 4,
                'mai': 5, 'jun': 6, 'jul': 7, 'ago': 8,
                'set': 9, 'out': 10, 'nov': 11, 'dez': 12
            };
            return meses[mesAbrev] || 0;
        }
        
        // Função para mostrar/esconder loading
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
                
                // Adicionar/remover classe para desativar scroll
                if (show) {
                    document.body.classList.add('no-scroll');
                } else {
                    document.body.classList.remove('no-scroll');
                }
            }
        }
        
        // ==================== FUNÇÕES DE PROCESSAMENTO DE DADOS ====================
        
        // Processar dados de despesa mensal
        function processDespesaMensalData(csvData) {
            const processedData = [];
            
            csvData.forEach(row => {
                if (row.unnamed_0 && row.despesa_bruta_com_pessoal_i) {
                    const mesAno = row.unnamed_0;
                    const mesAnoNormalizado = mesAno.replace('-', '_');
                    
                    const despesaBruta = converterValor(row.despesa_bruta_com_pessoal_i);
                    const pessoalAtivo = converterValor(row.pessoal_ativo);
                    const vencimentos = converterValor(row.vencimentos_vantagens_e_outras_despesas_variaveis);
                    const pessoalInativo = converterValor(row.pessoal_inativo_e_pensionistas);
                    const despesaLiquida = converterValor(row.despesa_liquida_com_pessoal_iii_i_ii);
                    const aposentadorias = converterValor(row.aposentadorias_reserva_e_reformas);
                    const pensoes = converterValor(row.pensoes);
                    const obrigacoesPatronais = converterValor(row.obrigacoes_patronais);
                    
                    if (despesaBruta > 0) {
                        processedData.push({
                            MES_ANO: mesAnoNormalizado,
                            MES_ORIGINAL: mesAno,
                            DESPESA_BRUTA: despesaBruta,
                            PESSOAL_ATIVO: pessoalAtivo,
                            VENCIMENTOS: vencimentos,
                            PESSOAL_INATIVO: pessoalInativo,
                            DESPESA_LIQUIDA: despesaLiquida,
                            APOSENTADORIAS: aposentadorias,
                            PENSÕES: pensoes,
                            OBRIGACOES_PATRONAIS: obrigacoesPatronais,
                            MES_FORMATADO: formatarMesAno(mesAno),
                            ANO: '20' + mesAno.split('-')[1],
                            MES_NUM: getMesNumero(mesAno.split('-')[0])
                        });
                    }
                }
            });
            
            // Ordenar por data
            processedData.sort((a, b) => {
                const [mesA, anoA] = a.MES_ANO.split('_');
                const [mesB, anoB] = b.MES_ANO.split('_');
                
                const anoNumA = parseInt(anoA);
                const anoNumB = parseInt(anoB);
                
                if (anoNumA !== anoNumB) {
                    return anoNumA - anoNumB;
                }
                
                return getMesNumero(mesA) - getMesNumero(mesB);
            });
            
            return processedData;
        }
        
        // Processar dados de limites LRF
        function processLimitesLRFData(csvData) {
            const processedLimites = [];
            
            csvData.forEach(row => {
                if (row.unnamed_0) {
                    const limiteMaximo = converterValor(row.limite_maximo_ix_incisos_i_ii_e_iii_art_20_da_lrf_49_00);
                    const limitePrudencial = converterValor(row.limite_prudencial_x_paragrafo_unico_art_22_da_lrf_46_55);
                    const limiteAlerta = converterValor(row.limite_de_alerta_xi_inciso_ii_do_SS_1o_do_art_59_da_lrf_44_10);
                    const despesaTotal = converterValor(row.despesa_total_com_pessoal_dtp_sobre_a_rcl_vii_iii_a_iii_b);
                    const rcl = converterValor(row.receita_corrente_liquida_rcl_iv);
                    const rclAjustada = converterValor(row.receita_corrente_liquida_ajustada_para_calculo_dos_limites_da_despesa_com_pessoal_vii_iv_v_vi);
                    
                    if (limiteMaximo > 0) {
                        processedLimites.push({
                            PERIODO: row.unnamed_0,
                            LIMITE_MAXIMO: limiteMaximo,
                            LIMITE_PRUDENCIAL: limitePrudencial,
                            LIMITE_ALERTA: limiteAlerta,
                            DESPESA_TOTAL: despesaTotal,
                            RCL: rcl,
                            RCL_AJUSTADA: rclAjustada,
                            FORMATADO: formatarPeriodoLRF(row.unnamed_0),
                            PERCENTUAL_UTILIZADO: despesaTotal > 0 ? (despesaTotal / limiteMaximo * 100) : 0
                        });
                    }
                }
            });
            
            return processedLimites;
        }
        
        // ==================== FUNÇÕES DE CARREGAMENTO ====================
        
        // Carregar dados do CSV
        async function loadCSVData(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    delimiter: ';',
                    skipEmptyLines: true,
                    encoding: 'UTF-8',
                    complete: function(results) {
                        resolve(results.data);
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }
        
        // Carregar dados de despesa mensal
        async function loadDespesaMensalData() {
            try {
                const url = 'https://raw.githubusercontent.com/transparencia-mg/despesa-pessoal-mg/main/dataset/data/despesa_pessoal_mensal.csv';
                const rawData = await loadCSVData(url);
                return processDespesaMensalData(rawData);
            } catch (error) {
                console.error('Erro ao carregar despesa mensal:', error);
                return [];
            }
        }
        
        // Carregar dados de limites LRF
        async function loadLimitesLRFData() {
            try {
                const url = 'https://raw.githubusercontent.com/transparencia-mg/despesa-pessoal-mg/main/dataset/data/limites_lrf.csv';
                const rawData = await loadCSVData(url);
                return processLimitesLRFData(rawData);
            } catch (error) {
                console.error('Erro ao carregar limites LRF:', error);
                return [];
            }
        }
        
        // Carregar todos os dados
        async function loadAllData() {
            showLoading(true);
            
            try {
                const [despesaData, limitesData] = await Promise.all([
                    loadDespesaMensalData(),
                    loadLimitesLRFData()
                ]);
                
                despesaMensalData = despesaData;
                limitesLRFData = limitesData;
                
                processDashboardData();
                updateFilterOptions();
                updateDashboard1();
                
                showLoading(false);
                
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                showLoading(false);
                alert("Erro ao carregar dados. Verifique o console para mais detalhes.");
            }
        }
        
        // Processar dados do dashboard
        function processDashboardData() {
            const dadosPorAno = {};
            
            despesaMensalData.forEach(item => {
                const ano = item.ANO;
                
                if (!dadosPorAno[ano]) {
                    dadosPorAno[ano] = [];
                }
                
                dadosPorAno[ano].push(item);
            });
            
            const anosOrdenados = Object.keys(dadosPorAno).sort((a, b) => b - a);
            
            anosOrdenados.forEach(ano => {
                const dadosAno = dadosPorAno[ano];
                const totalAno = dadosAno.reduce((sum, item) => sum + item.DESPESA_BRUTA, 0);
                const mediaAnual = totalAno / dadosAno.length;
                
                dadosAno.sort((a, b) => a.MES_NUM - b.MES_NUM);
                
                const ultimoMes = dadosAno[dadosAno.length - 1];
                
                dadosPorAno[ano] = {
                    dados: dadosAno,
                    total: totalAno,
                    media: mediaAnual,
                    ultimoMes: ultimoMes,
                    meses: dadosAno.length
                };
            });
            
            dashboardData = {
                porAno: dadosPorAno,
                anos: anosOrdenados,
                todosDados: despesaMensalData
            };
        }
        
        // ==================== FUNÇÕES DE ATUALIZAÇÃO DE UI ====================
        
	// Atualizar opções de filtro
function updateFilterOptions() {
    // Dashboard 1
    const anoSelect1 = document.getElementById('anoDashboard1');
    const mesSelect1 = document.getElementById('mesDashboard1');
    
    // REMOVER opção vazia - deixar apenas os anos disponíveis
    anoSelect1.innerHTML = '';
    // REMOVER opção vazia - deixar apenas os meses
    mesSelect1.innerHTML = '';
    
    if (dashboardData.anos && dashboardData.anos.length > 0) {
        const anosOrdenados = [...dashboardData.anos].sort((a, b) => b - a);
        const anoMaisRecente = anosOrdenados[0];

        anosOrdenados.forEach(ano => {
            const option = document.createElement('option');
            option.value = ano;
            option.textContent = ano;
            anoSelect1.appendChild(option);
        });
        
        // Selecionar automaticamente o ano mais recente
        if (anosOrdenados.length > 0) {
            anoSelect1.value = anoMaisRecente;
        }
        
        // OBTER MESES DISPONÍVEIS PARA O ANO MAIS RECENTE
        let mesesDisponiveis = [];
        
        if (despesaMensalData && despesaMensalData.length > 0) {
            // Filtrar dados do ano mais recente
            const dadosAnoRecente = despesaMensalData.filter(item => item.ANO === anoMaisRecente);
            
            if (dadosAnoRecente.length > 0) {
                // Obter meses únicos e ordenar
                const mesesUnicos = [...new Set(dadosAnoRecente.map(item => item.MES_NUM))];
                mesesDisponiveis = mesesUnicos.sort((a, b) => a - b);
                console.log('Meses disponíveis para', anoMaisRecente, ':', mesesDisponiveis);
            }
        }
        
        // Mapeamento de nomes dos meses
        const nomesMeses = {
            1: 'Janeiro', 2: 'Fevereiro', 3: 'Março', 4: 'Abril',
            5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
            9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
        };
        
        // ADICIONAR APENAS MESES QUE TÊM DADOS
        if (mesesDisponiveis.length > 0) {
            mesesDisponiveis.forEach(mesNum => {
                const option = document.createElement('option');
                option.value = mesNum;
                option.textContent = nomesMeses[mesNum] || `Mês ${mesNum}`;
                mesSelect1.appendChild(option);
            });
            
            // Selecionar o último mês disponível
            const ultimoMesDisponivel = mesesDisponiveis[mesesDisponiveis.length - 1];
            mesSelect1.value = ultimoMesDisponivel;
            console.log('Mês selecionado:', ultimoMesDisponivel);
            
        } else {
            // Se não há meses disponíveis
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Sem dados mensais';
            option.disabled = true;
            option.selected = true;
            mesSelect1.appendChild(option);
        }
        
    } else {
        // Se não houver anos, adicionar uma opção desabilitada
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Sem dados disponíveis';
        option.disabled = true;
        option.selected = true;
        anoSelect1.appendChild(option);
        
        const optionMes = document.createElement('option');
        optionMes.value = '';
        optionMes.textContent = 'Sem dados disponíveis';
        optionMes.disabled = true;
        optionMes.selected = true;
        mesSelect1.appendChild(optionMes);
    }
    
    // ADICIONAR EVENTO PARA ATUALIZAR MESES QUANDO ANO MUDAR
    anoSelect1.addEventListener('change', function() {
        const anoSelecionado = this.value;
        const mesSelect = document.getElementById('mesDashboard1');
        
        mesSelect.innerHTML = '';
        
        if (anoSelecionado) {
            // Obter meses disponíveis para o ano selecionado
            let mesesDisponiveis = [];
            
            if (despesaMensalData && despesaMensalData.length > 0) {
                const dadosAno = despesaMensalData.filter(item => item.ANO === anoSelecionado);
                
                if (dadosAno.length > 0) {
                    const mesesUnicos = [...new Set(dadosAno.map(item => item.MES_NUM))];
                    mesesDisponiveis = mesesUnicos.sort((a, b) => a - b);
                }
            }
            
            // Mapeamento de nomes
            const nomesMeses = {
                1: 'Janeiro', 2: 'Fevereiro', 3: 'Março', 4: 'Abril',
                5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
                9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
            };
            
            // Adicionar apenas meses disponíveis
            if (mesesDisponiveis.length > 0) {
                mesesDisponiveis.forEach(mesNum => {
                    const option = document.createElement('option');
                    option.value = mesNum;
                    option.textContent = nomesMeses[mesNum] || `Mês ${mesNum}`;
                    mesSelect.appendChild(option);
                });
                
                // Selecionar o último mês disponível
                const ultimoMesDisponivel = mesesDisponiveis[mesesDisponiveis.length - 1];
                mesSelect.value = ultimoMesDisponivel;
                
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Sem dados mensais';
                option.disabled = true;
                option.selected = true;
                mesSelect.appendChild(option);
            }
        }
        
        // Atualizar dashboard
        updateDashboard1();
    });
    
    // Dashboard 2
    const anoSelect2 = document.getElementById('anoDashboard2');
    if (anoSelect2) {
        // REMOVER opção vazia
        anoSelect2.innerHTML = '';
        
        if (dashboardData.anos && dashboardData.anos.length > 0) {
            // Ordenar anos do mais recente para o mais antigo
            const anosOrdenados = [...dashboardData.anos].sort((a, b) => parseInt(b) - parseInt(a));
            
            // Adicionar cada ano, selecionando o primeiro (mais recente)
            anosOrdenados.forEach((ano, index) => {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                
                // Selecionar o primeiro ano (mais recente) por padrão
                if (index === 0) {
                    option.selected = true;
                }
                
                anoSelect2.appendChild(option);
            });
            
            // Se selecionou algum ano, atualizar o dashboard 2
            if (anosOrdenados.length > 0) {
                // Pequeno delay para garantir que o DOM foi atualizado
                setTimeout(() => {
                    updateDashboard2();
                }, 50);
            }
        } else {
            // Se não houver anos, adicionar uma opção desabilitada
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Sem dados disponíveis';
            option.disabled = true;
            option.selected = true;
            anoSelect2.appendChild(option);
        }
    }
            
// Dashboard 3
const periodoLRFSelect = document.getElementById('periodoLRF');
if (periodoLRFSelect) {
    periodoLRFSelect.innerHTML = '<option value="">Selecione um período</option>';
    
    if (limitesLRFData && limitesLRFData.length > 0) {
        // Converter períodos para datas e encontrar o mais recente
        let periodoMaisRecente = null;
        let dataMaisRecente = null;
        
        limitesLRFData.forEach(limite => {
            const option = document.createElement('option');
            option.value = limite.PERIODO;
            option.textContent = limite.FORMATADO;
            periodoLRFSelect.appendChild(option);
            
            // Tentar extrair a data final do período
            const periodo = limite.PERIODO;
            
            // Formato esperado: "mes_ano_a_mes_ano" (ex: "jan_22_a_dez_22")
            if (periodo && periodo.includes('_a_')) {
                try {
                    const partes = periodo.split('_a_');
                    if (partes.length === 2) {
                        const dataFim = partes[1]; // Ex: "dez_22"
                        const [mesFim, anoFim] = dataFim.split('_');
                        
                        // Converter para data
                        const meses = {
                            'jan': 0, 'fev': 1, 'mar': 2, 'abr': 3, 'mai': 4, 'jun': 5,
                            'jul': 6, 'ago': 7, 'set': 8, 'out': 9, 'nov': 10, 'dez': 11
                        };
                        
                        const mesNum = meses[mesFim.toLowerCase()];
                        const anoNum = parseInt('20' + anoFim);
                        
                        if (mesNum !== undefined && !isNaN(anoNum)) {
                            const data = new Date(anoNum, mesNum);
                            
                            // Verificar se é a data mais recente
                            if (!dataMaisRecente || data > dataMaisRecente) {
                                dataMaisRecente = data;
                                periodoMaisRecente = limite.PERIODO;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Erro ao processar período:', periodo, error);
                }
            }
        });
        
        // Selecionar o período mais recente
        if (periodoMaisRecente) {
            periodoLRFSelect.value = periodoMaisRecente;
            console.log('Período mais recente selecionado:', periodoMaisRecente);
            
            // Atualizar o dashboard 3 automaticamente
            setTimeout(() => {
                updateDashboard3();
            }, 50);
        }
    }
}
            
            // Dashboard 4
            const anoDownloadSelect = document.getElementById('anoDownload');
            if (anoDownloadSelect) {
                anoDownloadSelect.innerHTML = '<option value="">Selecione um ano</option>';
                if (dashboardData.anos && dashboardData.anos.length > 0) {
                    dashboardData.anos.forEach(ano => {
                        const option = document.createElement('option');
                        option.value = ano;
                        option.textContent = ano;
                        anoDownloadSelect.appendChild(option);
                    });
                }
            }
        }
        
        // ==================== DASHBOARD 1: VISÃO GERAL ====================
        
        function updateDashboard1() {
            const anoSelecionado = document.getElementById('anoDashboard1')?.value || '';
            const mesSelecionado = document.getElementById('mesDashboard1')?.value || '';
            const categoriaSelecionada = document.getElementById('categoriaDashboard1')?.value || 'total';
            
            let dadosFiltrados = [];
            
            if (anoSelecionado && dashboardData.porAno[anoSelecionado]) {
                dadosFiltrados = dashboardData.porAno[anoSelecionado].dados || [];
            } else {
                dadosFiltrados = [...dashboardData.todosDados];
            }
            
            if (mesSelecionado) {
                const mesNum = parseInt(mesSelecionado);
                dadosFiltrados = dadosFiltrados.filter(item => item.MES_NUM === mesNum);
            }
            
            updateSummaryCards(dadosFiltrados);
            updateChartDistribuicao(dadosFiltrados, categoriaSelecionada);
            updateChartAtivoDetalhado(dadosFiltrados);
            updateResumoTable(dadosFiltrados);
        }
        
        function updateSummaryCards(dados) {
            const summaryCards = document.getElementById('summaryCards');
            if (!summaryCards) return;
            
            summaryCards.innerHTML = '';
            
            if (dados.length === 0) {
                summaryCards.innerHTML = `
                    <div class="col-12 text-center">
                        <p class="text-muted">Nenhum dado disponível para os filtros selecionados</p>
                    </div>
                `;
                return;
            }
            
            const ultimoMes = dados[dados.length - 1];
            const totalAno = dados.reduce((sum, item) => sum + item.DESPESA_BRUTA, 0);
            const mediaMensal = totalAno / dados.length;
            
            // Calcular variação mensal
            let variacaoMensal = 0;
            if (dados.length >= 2) {
                const mesAnterior = dados[dados.length - 2];
                if (mesAnterior && mesAnterior.DESPESA_BRUTA > 0) {
                    variacaoMensal = ((ultimoMes.DESPESA_BRUTA - mesAnterior.DESPESA_BRUTA) / mesAnterior.DESPESA_BRUTA * 100);
                }
            }
            
            // Calcular variação anual
            let variacaoAnual = 0;
            const anoAtual = ultimoMes.ANO;
            const anoAnterior = (parseInt(anoAtual) - 1).toString();
            
            if (dashboardData.porAno[anoAnterior]) {
                const dadosAnoAnterior = dashboardData.porAno[anoAnterior].dados;
                const totalAnoAnterior = dashboardData.porAno[anoAnterior].total;
                const mediaAnoAnterior = totalAnoAnterior / dadosAnoAnterior.length;
                
                if (mediaAnoAnterior > 0) {
                    variacaoAnual = ((mediaMensal - mediaAnoAnterior) / mediaAnoAnterior * 100);
                }
            }
            
            const cards = [
                {
                    title: 'Despesa Bruta Atual',
                    value: formatarMoeda(ultimoMes.DESPESA_BRUTA),
                    change: variacaoMensal,
                    changeLabel: 'vs mês anterior',
                    colorClass: 'primary',
                    icon: 'fas fa-money-bill-wave'
                },
                {
                    title: 'Média Mensal',
                    value: formatarMoeda(mediaMensal),
                    change: variacaoAnual,
                    changeLabel: 'vs ano anterior',
                    colorClass: 'info',
                    icon: 'fas fa-chart-line'
                },
                {
                    title: 'Pessoal Ativo',
                    value: formatarMoeda(ultimoMes.PESSOAL_ATIVO),
                    percentage: (ultimoMes.PESSOAL_ATIVO / ultimoMes.DESPESA_BRUTA * 100).toFixed(1) + '%',
                    colorClass: 'success',
                    icon: 'fas fa-user-tie'
                },
                {
                    title: 'Inativos/Pensionistas',
                    value: formatarMoeda(ultimoMes.PESSOAL_INATIVO),
                    percentage: (ultimoMes.PESSOAL_INATIVO / ultimoMes.DESPESA_BRUTA * 100).toFixed(1) + '%',
                    colorClass: 'warning',
                    icon: 'fas fa-users'
                }
            ];
            
            cards.forEach(card => {
                const changeClass = card.change > 0 ? 'danger' : (card.change < 0 ? 'positive' : 'warning');
                const changeSign = card.change > 0 ? '+' : '';
                
                const cardHTML = `
                    <div class="col-md-3 col-6">
                        <div class="metric-card ${card.colorClass}">
                            <div class="metric-label">${card.title}</div>
                            <div class="metric-value">${card.value}</div>
                            ${card.percentage ? `
                                <div class="metric-change ${parseFloat(card.percentage) > 50 ? 'warning' : 'positive'}">
                                    ${card.percentage} do total
                                </div>
                            ` : `
                                <div class="metric-change ${changeClass}">
                                    ${changeSign}${card.change ? card.change.toFixed(1) + '%' : '0%'} ${card.changeLabel || ''}
                                </div>
                            `}
                            <div class="mt-2">
                                <i class="${card.icon}" style="color: var(--${card.colorClass === 'primary' ? 'primary-dark' : card.colorClass}); opacity: 0.5;"></i>
                            </div>
                        </div>
                    </div>
                `;
                
                summaryCards.innerHTML += cardHTML;
            });
        }
        
        function updateChartDistribuicao(dados, categoria) {
            const canvas = document.getElementById('chartDistribuicao');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (chartDistribuicao) {
                chartDistribuicao.destroy();
            }
            
            const ultimoMes = dados[dados.length - 1];
            if (!ultimoMes) return;
            
            let labels = [];
            let values = [];
            let backgroundColor = [];
            
            switch(categoria) {
                case 'total':
                    labels = ['Pessoal Ativo', 'Inativos/Pensionistas', 'Outras Despesas'];
                    values = [
                        ultimoMes.PESSOAL_ATIVO,
                        ultimoMes.PESSOAL_INATIVO,
                        ultimoMes.DESPESA_BRUTA - ultimoMes.PESSOAL_ATIVO - ultimoMes.PESSOAL_INATIVO
                    ];
                    backgroundColor = ['#3498DB', '#E74C3C', '#9B59B6'];
                    break;
                    
                case 'ativo':
                    labels = ['Vencimentos', 'Obrigações Patronais', 'Outras Despesas'];
                    values = [
                        ultimoMes.VENCIMENTOS,
                        ultimoMes.OBRIGACOES_PATRONAIS,
                        ultimoMes.PESSOAL_ATIVO - ultimoMes.VENCIMENTOS - ultimoMes.OBRIGACOES_PATRONAIS
                    ];
                    backgroundColor = ['#2ECC71', '#F39C12', '#3498DB'];
                    break;
                    
                case 'inativo':
                    labels = ['Aposentadorias', 'Pensões', 'Outras Despesas'];
                    values = [
                        ultimoMes.APOSENTADORIAS,
                        ultimoMes.PENSÕES,
                        ultimoMes.PESSOAL_INATIVO - ultimoMes.APOSENTADORIAS - ultimoMes.PENSÕES
                    ];
                    backgroundColor = ['#E74C3C', '#9B59B6', '#F39C12'];
                    break;
                    
                case 'liquidada':
                    labels = ['Despesa Bruta', 'Deduções', 'Despesa Líquida'];
                    values = [
                        ultimoMes.DESPESA_BRUTA,
                        ultimoMes.DESPESA_BRUTA - ultimoMes.DESPESA_LIQUIDA,
                        ultimoMes.DESPESA_LIQUIDA
                    ];
                    backgroundColor = ['#3498DB', '#F39C12', '#2ECC71'];
                    break;
            }
            
            chartDistribuicao = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: backgroundColor,
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = values.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                    return `${context.label}: ${formatarMoeda(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateChartAtivoDetalhado(dados) {
            const canvas = document.getElementById('chartAtivoDetalhado');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (chartAtivoDetalhado) {
                chartAtivoDetalhado.destroy();
            }
            
            // Agrupar por ano
            const dadosPorAno = {};
            dados.forEach(item => {
                if (!dadosPorAno[item.ANO]) {
                    dadosPorAno[item.ANO] = [];
                }
                dadosPorAno[item.ANO].push(item);
            });
            
            const anos = Object.keys(dadosPorAno).sort();
            const labels = anos;
            const ativoData = anos.map(ano => {
                const dadosAno = dadosPorAno[ano];
                return dadosAno.reduce((sum, item) => sum + item.PESSOAL_ATIVO, 0) / dadosAno.length;
            });
            
            const inativoData = anos.map(ano => {
                const dadosAno = dadosPorAno[ano];
                return dadosAno.reduce((sum, item) => sum + item.PESSOAL_INATIVO, 0) / dadosAno.length;
            });
            
            chartAtivoDetalhado = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pessoal Ativo (Média)',
                            data: ativoData,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: '#3498DB',
                            borderWidth: 1
                        },
                        {
                            label: 'Inativos/Pensionistas (Média)',
                            data: inativoData,
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: '#E74C3C',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatarMoeda(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatarMoeda(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateResumoTable(dados) {
            const tableBody = document.getElementById('resumoTableBody');
            const resumoCount = document.getElementById('resumoCountDashboard1');
            
            if (!tableBody || !resumoCount) return;
            
            tableBody.innerHTML = '';
            
            if (dados.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">Nenhum dado disponível</td>
                    </tr>
                `;
                resumoCount.textContent = '0 registros';
                return;
            }
            
            const ultimoMes = dados[dados.length - 1];
            const totalBruto = ultimoMes.DESPESA_BRUTA;
            
            const categorias = [
                { nome: 'Despesa Bruta com Pessoal', valor: ultimoMes.DESPESA_BRUTA },
                { nome: 'Pessoal Ativo', valor: ultimoMes.PESSOAL_ATIVO },
                { nome: 'Vencimentos e Vantagens', valor: ultimoMes.VENCIMENTOS },
                { nome: 'Obrigações Patronais', valor: ultimoMes.OBRIGACOES_PATRONAIS },
                { nome: 'Inativos e Pensionistas', valor: ultimoMes.PESSOAL_INATIVO },
                { nome: 'Aposentadorias', valor: ultimoMes.APOSENTADORIAS },
                { nome: 'Pensões', valor: ultimoMes.PENSÕES },
                { nome: 'Despesa Líquida com Pessoal', valor: ultimoMes.DESPESA_LIQUIDA }
            ];
            
            categorias.forEach(categoria => {
                const porcentagem = totalBruto > 0 ? (categoria.valor / totalBruto * 100) : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${categoria.nome}</td>
                    <td class="text-end valor-monetario">${formatarMoeda(categoria.valor)}</td>
                    <td class="text-end">${porcentagem.toFixed(1)}%</td>
                    <td class="text-end">${formatarMoeda(categoria.valor / 12)}</td>
                `;
                tableBody.appendChild(row);
            });
            
            resumoCount.textContent = `${dados.length} registros`;
        }
        
        // ==================== DASHBOARD 2: EVOLUÇÃO MENSAL ====================
        
        function updateDashboard2() {
            const anoSelecionado = document.getElementById('anoDashboard2')?.value || '';
            const categoriaSelecionada = document.getElementById('categoriaDashboard2')?.value || 'total';
            
            let dadosFiltrados = [];
            
            if (anoSelecionado && dashboardData.porAno[anoSelecionado]) {
                dadosFiltrados = dashboardData.porAno[anoSelecionado].dados || [];
            } else {
                dadosFiltrados = [...dashboardData.todosDados];
            }
            
            updateChartEvolucao(dadosFiltrados, categoriaSelecionada);
            updateEvolucaoTable(dadosFiltrados);
        }
        
        function updateChartEvolucao(dados, categoria) {
            const canvas = document.getElementById('chartEvolucao');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (chartEvolucao) {
                chartEvolucao.destroy();
            }
            
            const labels = dados.map(item => item.MES_FORMATADO);
            let data = [];
            
            switch(categoria) {
                case 'total':
                    data = dados.map(item => item.DESPESA_BRUTA);
                    break;
                case 'bruta':
                    data = dados.map(item => item.DESPESA_BRUTA);
                    break;
                case 'liquida':
                    data = dados.map(item => item.DESPESA_LIQUIDA);
                    break;
                case 'ativo':
                    data = dados.map(item => item.PESSOAL_ATIVO);
                    break;
                case 'inativo':
                    data = dados.map(item => item.PESSOAL_INATIVO);
                    break;
            }
            
            const toggleAccumulated = document.getElementById('toggleAccumulated')?.checked || false;
            let finalData = data;
            let datasetLabel = '';
            
            switch(categoria) {
                case 'total':
                    datasetLabel = toggleAccumulated ? 'Despesa Total Acumulada' : 'Despesa Total';
                    break;
                case 'bruta':
                    datasetLabel = toggleAccumulated ? 'Despesa Bruta Acumulada' : 'Despesa Bruta';
                    break;
                case 'liquida':
                    datasetLabel = toggleAccumulated ? 'Despesa Líquida Acumulada' : 'Despesa Líquida';
                    break;
                case 'ativo':
                    datasetLabel = toggleAccumulated ? 'Pessoal Ativo Acumulado' : 'Pessoal Ativo';
                    break;
                case 'inativo':
                    datasetLabel = toggleAccumulated ? 'Inativos/Pensionistas Acumulado' : 'Inativos/Pensionistas';
                    break;
            }
            
            if (toggleAccumulated) {
                finalData = [];
                let acumulado = 0;
                data.forEach(valor => {
                    acumulado += valor;
                    finalData.push(acumulado);
                });
            }
            
            chartEvolucao = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: datasetLabel,
                        data: finalData,
                        borderColor: '#3498DB',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: !toggleAccumulated,
                            ticks: {
                                callback: function(value) {
                                    return formatarMoeda(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatarMoeda(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateEvolucaoTable(dados) {
            const tableBody = document.getElementById('evolucaoTableBody');
            const resumoCount = document.getElementById('resumoCountDashboard2');
            
            if (!tableBody || !resumoCount) return;
            
            tableBody.innerHTML = '';
            
            if (dados.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">Nenhum dado disponível</td>
                    </tr>
                `;
                resumoCount.textContent = '0 registros';
                return;
            }
            
            dados.forEach((item, index) => {
                let variacao = '--';
                if (index > 0) {
                    const mesAnterior = dados[index - 1];
                    if (mesAnterior && mesAnterior.DESPESA_BRUTA > 0) {
                        const variacaoValor = ((item.DESPESA_BRUTA - mesAnterior.DESPESA_BRUTA) / mesAnterior.DESPESA_BRUTA * 100);
                        variacao = `${variacaoValor.toFixed(1)}%`;
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.MES_FORMATADO}</strong></td>
                    <td class="text-end valor-monetario">${formatarMoeda(item.DESPESA_BRUTA)}</td>
                    <td class="text-end valor-monetario">${formatarMoeda(item.DESPESA_LIQUIDA)}</td>
                    <td class="text-end valor-monetario">${formatarMoeda(item.PESSOAL_ATIVO)}</td>
                    <td class="text-end valor-monetario">${formatarMoeda(item.PESSOAL_INATIVO)}</td>
                    <td class="text-end ${variacao.includes('-') ? 'valor-positivo' : 'valor-negativo'}">
                        ${variacao}
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            resumoCount.textContent = `${dados.length} registros`;
        }
        
        // ==================== DASHBOARD 3: LIMITES DA LRF ====================
        
        function updateDashboard3() {
            const periodoSelecionado = document.getElementById('periodoLRF')?.value || '';
            
            if (!periodoSelecionado) return;
            
            const limite = limitesLRFData.find(l => l.PERIODO === periodoSelecionado);
            if (!limite) return;
            
            updateLimitesCards(limite);
            updateProgressBar(limite);
            updateLimitesTable(limite);
        }
        
        function updateLimitesCards(limite) {
            const limiteLegalValor = document.getElementById('limiteLegalValor');
            const limitePrudencialValor = document.getElementById('limitePrudencialValor');
            const limiteAlertaValor = document.getElementById('limiteAlertaValor');
            const despesaAtualPercentual = document.getElementById('despesaAtualPercentual');
            const rclTotal = document.getElementById('rclTotal');
            const despesaExecutada = document.getElementById('despesaExecutada');
            
            if (limiteLegalValor) limiteLegalValor.textContent = formatarMoeda(limite.LIMITE_MAXIMO);
            if (limitePrudencialValor) limitePrudencialValor.textContent = formatarMoeda(limite.LIMITE_PRUDENCIAL);
            if (limiteAlertaValor) limiteAlertaValor.textContent = formatarMoeda(limite.LIMITE_ALERTA);
            
            const percentualUtilizado = limite.PERCENTUAL_UTILIZADO;
            if (despesaAtualPercentual) despesaAtualPercentual.textContent = percentualUtilizado.toFixed(1) + '%';
            
            if (rclTotal) rclTotal.textContent = formatarMoeda(limite.RCL_AJUSTADA);
            if (despesaExecutada) despesaExecutada.textContent = formatarMoeda(limite.DESPESA_TOTAL);
            
            // Atualizar cores dos cards baseado no percentual
            const limiteLegalCard = document.getElementById('limiteLegalCard');
            const limitePrudencialCard = document.getElementById('limitePrudencialCard');
            const limiteAlertaCard = document.getElementById('limiteAlertaCard');
            
            if (limiteLegalCard && limitePrudencialCard && limiteAlertaCard) {
                if (percentualUtilizado >= 90) {
                    limiteLegalCard.className = 'limite-card danger';
                    limitePrudencialCard.className = 'limite-card danger';
                    limiteAlertaCard.className = 'limite-card danger';
                } else if (percentualUtilizado >= 80) {
                    limiteLegalCard.className = 'limite-card warning';
                    limitePrudencialCard.className = 'limite-card warning';
                    limiteAlertaCard.className = 'limite-card warning';
                } else {
                    limiteLegalCard.className = 'limite-card safe';
                    limitePrudencialCard.className = 'limite-card warning';
                    limiteAlertaCard.className = 'limite-card danger';
                }
            }
        }
        
        function updateProgressBar(limite) {
            const progressBar = document.getElementById('progressBar');
            if (!progressBar) return;
            
            const percentualUtilizado = limite.PERCENTUAL_UTILIZADO;
            
            let width = Math.min(100, percentualUtilizado);
            progressBar.style.width = width + '%';
            
            // Definir cor da barra de progresso
            if (percentualUtilizado >= 90) {
                progressBar.className = 'progress-bar-limite danger';
            } else if (percentualUtilizado >= 80) {
                progressBar.className = 'progress-bar-limite warning';
            } else {
                progressBar.className = 'progress-bar-limite safe';
            }
            
            // Atualizar labels
            const limiteAlertaLabel = document.getElementById('limiteAlertaValorLabel');
            const limitePrudencialLabel = document.getElementById('limitePrudencialValorLabel');
            const limiteLegalLabel = document.getElementById('limiteLegalValorLabel');
            
            if (limiteAlertaLabel) limiteAlertaLabel.textContent = '44.10%';
            if (limitePrudencialLabel) limitePrudencialLabel.textContent = '46.55%';
            if (limiteLegalLabel) limiteLegalLabel.textContent = '49.00%';
        }
        
        function updateLimitesTable(limite) {
            const tableBody = document.getElementById('limitesTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            const linhas = [
                { descricao: 'Receita Corrente Líquida (RCL)', valor: limite.RCL, percentual: 100.00 },
                { descricao: '(-) Transferências Obrigatórias da União', valor: 0, percentual: 0 },
                { descricao: 'Receita Corrente Líquida Ajustada', valor: limite.RCL_AJUSTADA, percentual: 100.00 },
                { descricao: 'Despesa Total com Pessoal (DTP)', valor: limite.DESPESA_TOTAL, percentual: limite.PERCENTUAL_UTILIZADO },
                { descricao: 'Limite de Alerta (44.10% da RCL)', valor: limite.LIMITE_ALERTA, percentual: 44.10 },
                { descricao: 'Limite Prudencial (46.55% da RCL)', valor: limite.LIMITE_PRUDENCIAL, percentual: 46.55 },
                { descricao: 'Limite Legal (49.00% da RCL)', valor: limite.LIMITE_MAXIMO, percentual: 49.00 }
            ];
            
            linhas.forEach(linha => {
                const row = document.createElement('tr');
                const percentualClass = linha.percentual >= 90 ? 'valor-negativo' : 
                                      linha.percentual >= 80 ? 'valor-negativo' : 'valor-positivo';
                
                row.innerHTML = `
                    <td>${linha.descricao}</td>
                    <td class="text-end valor-monetario">${formatarMoeda(linha.valor)}</td>
                    <td class="text-end ${percentualClass}">${linha.percentual.toFixed(2)}%</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // ==================== EVENT LISTENERS ====================
        
        // Dashboard 1
        const aplicarFiltrosBtn = document.getElementById('aplicarFiltros');
        if (aplicarFiltrosBtn) {
            aplicarFiltrosBtn.addEventListener('click', updateDashboard1);
        }
        
        const limparFiltrosBtn = document.getElementById('limparFiltros');
        if (limparFiltrosBtn) {
            limparFiltrosBtn.addEventListener('click', function() {
                document.getElementById('anoDashboard1').value = '';
                document.getElementById('mesDashboard1').value = '';
                document.getElementById('categoriaDashboard1').value = 'total';
                updateDashboard1();
            });
        }
        
        const categoriaDashboard1 = document.getElementById('categoriaDashboard1');
        if (categoriaDashboard1) {
            categoriaDashboard1.addEventListener('change', updateDashboard1);
        }
        
        // Dashboard 2
        const aplicarFiltrosDashboard2Btn = document.getElementById('aplicarFiltrosDashboard2');
        if (aplicarFiltrosDashboard2Btn) {
            aplicarFiltrosDashboard2Btn.addEventListener('click', updateDashboard2);
        }
        
        const categoriaDashboard2 = document.getElementById('categoriaDashboard2');
        if (categoriaDashboard2) {
            categoriaDashboard2.addEventListener('change', updateDashboard2);
        }
        
        const toggleAccumulated = document.getElementById('toggleAccumulated');
        if (toggleAccumulated) {
            toggleAccumulated.addEventListener('change', updateDashboard2);
        }
        
        // Dashboard 3
        const periodoLRF = document.getElementById('periodoLRF');
        if (periodoLRF) {
            periodoLRF.addEventListener('change', updateDashboard3);
        }
        
        // Dashboard 4
        const atualizarDadosGitHubBtn = document.getElementById('atualizarDadosGitHub');
        if (atualizarDadosGitHubBtn) {
            atualizarDadosGitHubBtn.addEventListener('click', loadAllData);
        }
        
        const downloadQuadrimestreCSVBtn = document.getElementById('downloadQuadrimestreCSV');
        if (downloadQuadrimestreCSVBtn) {
            downloadQuadrimestreCSVBtn.addEventListener('click', function() {
                const ano = document.getElementById('anoDownload')?.value || '';
                const quadrimestre = document.getElementById('quadrimestreDownload')?.value || '1';
                
                if (!ano) {
                    alert('Por favor, selecione um ano.');
                    return;
                }
                
                // Filtrar dados pelo quadrimestre
                let meses = [];
                switch(quadrimestre) {
                    case '1': meses = [1, 2, 3, 4]; break; // Jan-Abr
                    case '2': meses = [5, 6, 7, 8]; break; // Mai-Ago
                    case '3': meses = [9, 10, 11, 12]; break; // Set-Dez
                }
                
                const dadosFiltrados = despesaMensalData.filter(item => 
                    item.ANO === ano && meses.includes(item.MES_NUM)
                );
                
                if (dadosFiltrados.length === 0) {
                    alert('Não há dados para o período selecionado.');
                    return;
                }
                
                // Criar CSV
                let csvContent = 'Mês;Despesa Bruta;Pessoal Ativo;Inativos/Pensionistas;Despesa Líquida\n';
                
                dadosFiltrados.forEach(item => {
                    csvContent += `${item.MES_FORMATADO};${item.DESPESA_BRUTA};${item.PESSOAL_ATIVO};${item.PESSOAL_INATIVO};${item.DESPESA_LIQUIDA}\n`;
                });
                
                // Criar link de download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `despesa_pessoal_${ano}_quadrimestre_${quadrimestre}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`CSV baixado com sucesso! ${dadosFiltrados.length} registros exportados.`);
            });
        }
        
        // Exportar CSV Dashboard 1
        const exportCSVDashboard1Btn = document.getElementById('exportCSVDashboard1');
        if (exportCSVDashboard1Btn) {
            exportCSVDashboard1Btn.addEventListener('click', function() {
                const anoSelecionado = document.getElementById('anoDashboard1')?.value || '';
                const mesSelecionado = document.getElementById('mesDashboard1')?.value || '';
                
                let dadosFiltrados = [];
                
                if (anoSelecionado && dashboardData.porAno[anoSelecionado]) {
                    dadosFiltrados = dashboardData.porAno[anoSelecionado].dados || [];
                } else {
                    dadosFiltrados = [...dashboardData.todosDados];
                }
                
                if (mesSelecionado) {
                    const mesNum = parseInt(mesSelecionado);
                    dadosFiltrados = dadosFiltrados.filter(item => item.MES_NUM === mesNum);
                }
                
                if (dadosFiltrados.length === 0) {
                    alert('Não há dados para exportar.');
                    return;
                }
                
                let csvContent = 'Mês;Despesa Bruta;Pessoal Ativo;Vencimentos;Obrigações Patronais;Inativos/Pensionistas;Aposentadorias;Pensões;Despesa Líquida\n';
                
                dadosFiltrados.forEach(item => {
                    csvContent += `${item.MES_FORMATADO};${item.DESPESA_BRUTA};${item.PESSOAL_ATIVO};${item.VENCIMENTOS};${item.OBRIGACOES_PATRONAIS};${item.PESSOAL_INATIVO};${item.APOSENTADORIAS};${item.PENSÕES};${item.DESPESA_LIQUIDA}\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', 'despesa_pessoal_resumo.csv');
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`CSV exportado com sucesso! ${dadosFiltrados.length} registros exportados.`);
            });
        }
        
        // Exportar CSV Dashboard 2
        const exportCSVDashboard2Btn = document.getElementById('exportCSVDashboard2');
        if (exportCSVDashboard2Btn) {
            exportCSVDashboard2Btn.addEventListener('click', function() {
                const anoSelecionado = document.getElementById('anoDashboard2')?.value || '';
                const categoriaSelecionada = document.getElementById('categoriaDashboard2')?.value || 'total';
                
                let dadosFiltrados = [];
                
                if (anoSelecionado && dashboardData.porAno[anoSelecionado]) {
                    dadosFiltrados = dashboardData.porAno[anoSelecionado].dados || [];
                } else {
                    dadosFiltrados = [...dashboardData.todosDados];
                }
                
                if (dadosFiltrados.length === 0) {
                    alert('Não há dados para exportar.');
                    return;
                }
                
                let csvContent = 'Mês;Despesa Bruta;Despesa Líquida;Pessoal Ativo;Inativos/Pensionistas;Variação Mês Anterior\n';
                
                dadosFiltrados.forEach((item, index) => {
                    let variacao = 0;
                    if (index > 0) {
                        const mesAnterior = dadosFiltrados[index - 1];
                        if (mesAnterior && mesAnterior.DESPESA_BRUTA > 0) {
                            variacao = ((item.DESPESA_BRUTA - mesAnterior.DESPESA_BRUTA) / mesAnterior.DESPESA_BRUTA * 100);
                        }
                    }
                    
                    csvContent += `${item.MES_FORMATADO};${item.DESPESA_BRUTA};${item.DESPESA_LIQUIDA};${item.PESSOAL_ATIVO};${item.PESSOAL_INATIVO};${variacao.toFixed(1)}%\n`;
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', 'despesa_pessoal_evolucao.csv');
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`CSV exportado com sucesso! ${dadosFiltrados.length} registros exportados.`);
            });
        }
        
        // Imprimir Dashboard 1
        const printDashboard1Btn = document.getElementById('printDashboard1');
        if (printDashboard1Btn) {
            printDashboard1Btn.addEventListener('click', function() {
                window.print();
            });
        }
        
        // Imprimir Dashboard 2
        const printDashboard2Btn = document.getElementById('printDashboard2');
        if (printDashboard2Btn) {
            printDashboard2Btn.addEventListener('click', function() {
                window.print();
            });
        }
        
        // ==================== INICIALIZAÇÃO ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Buscar data do GitHub
            fetchGitHubLastUpdate();
            
            // Inicializar tooltips do Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Carregar dados
            loadAllData();
            
            // Configurar intervalo para atualizar data do GitHub (opcional)
            // setInterval(fetchGitHubLastUpdate, 10 * 60 * 1000); // A cada 10 minutos
        });
    </script>
</body>
</html>