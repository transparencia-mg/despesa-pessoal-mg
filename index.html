<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Despesa com Pessoal MG</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse para CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        /* ==================== VARIÁVEIS DE CORES ==================== */
        :root {
            --primary-dark: #29435A;
            --primary-darker: #132837;
            --accent-red: #B93C42;
            --accent-bright: #DB233F;
            --background-light: #EEEFF5;
            
            --success-green: #28a745;
            --warning-yellow: #ffc107;
            --info-blue: #17a2b8;
            
            --secondary-blue: #3F704D;
            --secondary-brown: #8B7355;
            --secondary-teal: #20B2AA;
            --hover-blue: #006a82;
            
            /* ===== NOVAS PARA GRÁFICOS ===== */
            --chart-blue-1: #2F5D8A;
            --chart-blue-2: #4A7DAA;
            --chart-blue-3: #1F6F8B;
            
            --chart-orange-1: #D97A30;
            --chart-orange-2: #C65A2C;
            --chart-red-2:    #A8323A;
            
            --chart-green-1: #2F7A5C;
            --chart-green-2: #5A8F6E;
            --chart-lime:    #7FAF3F;
            
            --chart-purple: #6B5B95;
            --chart-gray:   #6C7A89;
            --chart-brown:  #9C6B4A;
        }
        
        /* ==================== ESTILOS GERAIS ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            overflow-x: hidden;
            height: auto !important;
            overflow-y: visible !important;
        }
        
        body {
            font-family: 'Montserrat', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-light);
            padding-top: 20px;
            padding-bottom: 40px;
        }
        
        /* Remover scroll do body */
        body.no-scroll {
            overflow: hidden;
        }
        
        /* ==================== DATA ATUALIZAÇÃO CENTRALIZADA ==================== */
        .data-atualizacao-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }
        
        .data-atualizacao-box {
            background: white;
            border-radius: 8px;
            padding: 8px 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 12px;
            color: var(--primary-dark);
            font-weight: 600;
        }
        
        .data-atualizacao-box i {
            font-size: 14px;
            color: var(--accent-red);
        }
        
        /* ==================== MENU DE NAVEGAÇÃO ==================== */
        .nav-tabs-container {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
            margin-top: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .nav-tabs {
            border: none !important;
            gap: 4px;
            flex-wrap: nowrap;
            min-width: max-content;
            padding-bottom: 5px;
            margin-bottom: 0 !important;
        }
        
        .nav-tabs .nav-item {
            flex-shrink: 0;
        }
        
        .nav-tabs .nav-link {
            border: none !important;
            border-radius: 6px !important;
            padding: 10px 15px !important;
            font-weight: 600;
            color: var(--primary-dark) !important;
            transition: all 0.3s ease;
            font-size: 13px;
            white-space: nowrap;
            display: inline-flex !important;
            align-items: center;
            background: none !important;
        }
        
        .nav-tabs .nav-link:hover {
            background-color: rgba(41, 67, 90, 0.05) !important;
            color: var(--accent-red) !important;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-darker) 100%) !important;
            color: white !important;
            border: none !important;
        }
        
        .nav-tabs .nav-link .material-icons {
            font-size: 16px !important;
            margin-right: 8px !important;
            vertical-align: middle;
            line-height: 1;
        }
        
        .nav-tabs .nav-link.active .material-icons {
            color: white !important;
        }
        
        .nav-tabs-container::-webkit-scrollbar {
            height: 4px;
        }
        
        .nav-tabs-container::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .nav-tabs-container::-webkit-scrollbar-thumb {
            background: #dee2e6;
            border-radius: 4px;
        }
        
        .nav-tabs-container::-webkit-scrollbar-thumb:hover {
            background: #adb5bd;
        }
        
        .nav-tabs-container {
            scrollbar-width: thin;
            scrollbar-color: #dee2e6 #f8f9fa;
        }
        
        .nav-tabs {
            border-bottom: none !important;
        }
        
        /* ==================== FILTROS ==================== */
        .filter-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid var(--accent-red);
        }
        
        .filter-label {
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 6px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 13px;
            transition: all 0.3s ease;
            height: 42px;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--accent-red);
            box-shadow: 0 0 0 2px rgba(185, 60, 66, 0.15);
        }
        
        /* ==================== BOTÕES ==================== */
        .btn-primary-custom {
            background: var(--accent-red);
            border: 2px solid var(--accent-red);
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 13px;
            color: white;
            cursor: pointer;
        }
        
        .btn-primary-custom:hover {
            background: var(--primary-darker);
            border-color: var(--primary-darker);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(19, 40, 55, 0.2);
            color: white;
        }
        
        .btn-secondary-custom {
            background: white;
            border: 2px solid var(--primary-darker);
            color: var(--primary-darker);
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 13px;
            cursor: pointer;
        }
        
        .btn-secondary-custom:hover {
            background-color: var(--primary-darker);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(19, 40, 55, 0.15);
        }
        
        .btn-export {
            background: white;
            border: 2px solid var(--primary-darker);
            color: var(--primary-darker);
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .btn-export:hover {
            background: var(--primary-darker);
            color: white;
            transform: translateY(-1px);
            text-decoration: none;
        }
        
        .btn-share {
            background: white;
            border: 2px solid var(--primary-darker);
            color: var(--primary-darker);
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        
        .btn-share:hover {
            background: var(--primary-darker);
            color: white;
        }
        
        .share-options {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 180px;
            margin-top: 5px;
        }
        
        .share-options.show {
            display: block;
        }
        
        .share-option {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-dark);
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.2s ease;
            cursor: pointer;
            font-size: 12px;
        }
        
        .share-option:hover {
            background-color: rgba(41, 67, 90, 0.05);
        }
        
        /* ==================== CARDS DE MÉTRICAS ==================== */
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px 15px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
            border-top: 4px solid var(--accent-red);
            transition: all 0.3s ease;
            height: 100%;
            position: relative;
            cursor: default;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-dark);
            margin: 8px 0;
            line-height: 1;
        }
        
        .metric-label {
            font-size: 12px;
            color: var(--primary-darker);
            font-weight: 600;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        /* ==================== CONTAINER DE GRÁFICOS ==================== */
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
            height: 100%;
            min-height: 280px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--background-light);
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-dark);
            margin: 0;
        }
        
        .chart-wrapper {
            position: relative;
            height: 220px;
            width: 100%;
        }
        
        /* ==================== TABELAS COM BORDAS ==================== */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        
        .table-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-darker) 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .table-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }
        
        .table-badge {
            background: var(--accent-red);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .table-fixed-header-container {
            position: relative;
            max-height: 500px;
            overflow: auto;
            padding: 0;
        }
        
        .table-fixed-header-container table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--primary-dark) !important;
        }
        
        .table-fixed-header-container table thead th {
            background-color: var(--primary-dark) !important;
            color: white !important;
            position: sticky;
            top: 0;
            z-index: 20;
        }
        
        .table-responsive {
            padding: 0;
            overflow-x: auto;
        }
        
        .table {
            margin: 0;
            width: 100%;
            font-size: 13px;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid #dee2e6;
        }
        
        .table thead th {
            background-color: var(--primary-dark) !important;
            color: white !important;
            font-weight: 600;
            border: none;
            padding: 12px 10px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
            position: sticky;
            top: 0;
            z-index: 20;
            white-space: nowrap;
            border-left: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-right: 1px solid rgba(255, 255, 255, 0.2) !important;
        }
        
        .table thead th:first-child {
            border-left: none !important;
        }
        
        .table thead th:last-child {
            border-right: none !important;
        }
        
        .table thead th:hover {
            background-color: var(--primary-darker) !important;
        }
        
        .table-container table th, 
        .table-container table td {
            border-left: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            vertical-align: middle;
        }
        
        .table-container table th:first-child,
        .table-container table td:first-child {
            border-left: none;
        }
        
        .table-container table th:last-child,
        .table-container table td:last-child {
            border-right: none;
        }
        
        .table-container table tbody tr {
            border-bottom: 1px solid #f1f1f1;
        }
        
        .table-container table tbody tr:last-child {
            border-bottom: none;
        }
        
        .table tbody tr {
            transition: background-color 0.2s ease;
        }
        
        .table tbody tr:hover {
            background-color: rgba(41, 67, 90, 0.04);
        }
        
        .table tbody td {
            padding: 12px 10px;
            vertical-align: middle;
            font-size: 13px;
        }
        
        .valor-monetario {
            font-weight: 600;
            text-align: right;
            white-space: nowrap;
            font-size: 13px;
        }
        
        .valor-positivo {
            color: var(--success-green);
        }
        
        .valor-negativo {
            color: var(--accent-red);
        }
        
        /* ==================== AÇÕES ==================== */
        .actions-container {
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .export-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            position: relative;
        }
        
        /* ==================== LOADING OVERLAY ==================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(41, 67, 90, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent-red);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        /* ==================== BARRAS DE PROGRESSO ==================== */
        .progress-limite {
            height: 20px;
            border-radius: 10px;
            background-color: #e9ecef;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-bar-limite {
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .progress-bar-limite.safe {
            background-color: var(--success-green);
        }
        
        .progress-bar-limite.warning {
            background-color: var(--warning-yellow);
        }
        
        .progress-bar-limite.danger {
            background-color: var(--accent-red);
        }
        
        /* ==================== LIMITES LRF ==================== */
        .limites-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .limite-info-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
            border-top: 4px solid var(--accent-red);
        }
        
        .limite-periodo {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 15px;
            text-align: center;
            background: rgba(41, 67, 90, 0.05);
            padding: 8px;
            border-radius: 6px;
        }
        
        .limite-dados {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .limite-item {
            display: flex;
            flex-direction: column;
            padding: 10px;
            background: rgba(41, 67, 90, 0.02);
            border-radius: 6px;
            border-left: 3px solid var(--accent-red);
        }
        
        .limite-item-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--primary-darker);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 5px;
        }
        
        .limite-item-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-dark);
        }
        
        .limite-item-percentual {
            font-size: 14px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-top: 5px;
        }
        
        .limite-item-percentual.safe {
            background-color: rgba(40, 167, 69, 0.1);
            color: var(--success-green);
        }
        
        .limite-item-percentual.warning {
            background-color: rgba(255, 193, 7, 0.1);
            color: var(--warning-yellow);
        }
        
        .limite-item-percentual.danger {
            background-color: rgba(185, 60, 66, 0.1);
            color: var(--accent-red);
        }
        
        .limite-atingido-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
            border-top: 4px solid var(--accent-red);
        }
        
        .limite-atingido-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .limite-atingido-value {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .limite-atingido-value.safe {
            color: var(--success-green);
        }
        
        .limite-atingido-value.warning {
            color: var(--warning-yellow);
        }
        
        .limite-atingido-value.danger {
            color: var(--accent-red);
        }
        
        /* ==================== DOWNLOAD GRID ==================== */
        .download-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .download-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.06);
            border-top: 4px solid var(--accent-red);
        }
        
        .download-card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 15px;
            word-break: break-all;
        }
        
        .download-card-desc {
            font-size: 13px;
            color: var(--primary-darker);
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .download-card-info {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* ==================== ANIMAÇÃO ==================== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ==================== RESPONSIVIDADE ==================== */
        @media (max-width: 768px) {
            .metric-value {
                font-size: 20px;
            }
            
            .actions-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .export-buttons {
                width: 100%;
            }
            
            .chart-wrapper {
                height: 200px;
            }
            
            .limite-dados {
                grid-template-columns: 1fr;
            }
            
            .limites-container {
                grid-template-columns: 1fr;
            }
            
            .download-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- ==================== MENU DE NAVEGAÇÃO ==================== -->
    <div class="container-fluid px-4">
        <div class="nav-tabs-container">
            <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dashboard1-tab" data-bs-toggle="tab" data-bs-target="#dashboard1" type="button" role="tab">
                        <span class="material-icons">bar_chart</span>
                        Visão Geral
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="dashboard2-tab" data-bs-toggle="tab" data-bs-target="#dashboard2" type="button" role="tab">
                        <span class="material-icons">date_range</span>
                        Evolução Mensal
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="dashboard3-tab" data-bs-toggle="tab" data-bs-target="#dashboard3" type="button" role="tab">
                        <span class="material-icons">balance</span>
                        Limites da LRF
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="dashboard4-tab" data-bs-toggle="tab" data-bs-target="#dashboard4" type="button" role="tab">
                        <span class="material-icons">download</span>
                        Downloads
                    </button>
                </li>
            </ul>
        </div>

        <!-- ==================== DATA DE ATUALIZAÇÃO CENTRALIZADA ==================== -->
        <div class="data-atualizacao-container">
            <div class="data-atualizacao-box">
                <span class="material-icons" style="color: var(--accent-red); font-size: 16px;">update</span>
                Atualizado em: <span id="data-atualizacao-header">Carregando...</span>
            </div>
        </div>

        <!-- ==================== LOADING OVERLAY ==================== -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="text-center">
                <div class="spinner"></div>
                <p class="mt-3" style="color: var(--primary-dark); font-weight: 600;">Carregando dados...</p>
            </div>
        </div>

        <!-- ==================== CONTEÚDO DAS ABAS ==================== -->
        <div class="tab-content" id="dashboardTabsContent">
            
            <!-- ==================== DASHBOARD 1: VISÃO GERAL ==================== -->
            <div class="tab-pane fade show active" id="dashboard1" role="tabpanel">
                
                <!-- Filtros Dashboard 1 -->
                <div class="filter-container">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="anoDashboard1" class="form-label filter-label">Ano</label>
                                <select class="form-select" id="anoDashboard1">
                                    <option value="">Selecione</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="mesDashboard1" class="form-label filter-label">Mês</label>
                                <select class="form-select" id="mesDashboard1">
                                    <option value="">Selecione</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex gap-3 flex-wrap">
                                <button class="btn-primary-custom" id="aplicarFiltros">
                                    <span class="material-icons" style="font-size: 14px; margin-right: 6px;">filter_alt</span>
                                    Aplicar Filtros
                                </button>
                                <button class="btn-secondary-custom" id="limparFiltros">
                                    <span class="material-icons" style="font-size: 14px; margin-right: 6px;">refresh</span>
                                    Limpar Filtros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cards de Estatísticas Dashboard 1 -->
                <div class="row mb-4" id="summaryCards"></div>

                <!-- Gráficos Dashboard 1 -->
                <div class="row mb-4">
                    <div class="col-md-6 col-12">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h4 class="chart-title">Distribuição da Despesa</h4>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="chartDistribuicao"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-12">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h4 class="chart-title">Despesa com Pessoal Ativo</h4>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="chartAtivoDetalhado"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                    <!-- Barra de Ferramentas Dashboard 1 -->
                    <div class="actions-container mb-4">
                        <div class="export-buttons">
                            <button class="btn-export" id="exportCSVDashboard1">
                                <i class="material-icons me-2">description</i>Exportar CSV
                            </button>
                            <button class="btn-print" id="printDashboard1">
                                <i class="material-icons me-2">print</i>Imprimir
                            </button>
                            <div class="share-wrapper">
                                <button class="btn-share" id="shareDashboard1" onclick="toggleShareOptions(event, 'dashboard1')">
                                    <i class="material-icons me-2">share</i>Compartilhar
                                </button>
                                <div class="share-options" id="shareOptions-dashboard1">
                                    <a href="#" onclick="copiarLink(); return false;">
                                        <i class="material-icons">link</i>Copiar link
                                    </a>
                                    <a href="#" onclick="compartilharFacebook(event);">
                                        <i class="fab fa-facebook"></i>Facebook
                                    </a>
                                    <a href="#" onclick="compartilharTwitter(event);">
                                        <i class="fab fa-twitter"></i>Twitter
                                    </a>
                                    <a href="#" onclick="compartilharLinkedIn(event);">
                                        <i class="fab fa-linkedin"></i>LinkedIn
                                    </a>
                                    <a href="#" onclick="compartilharWhatsApp(event);">
                                        <i class="fab fa-whatsapp"></i>WhatsApp
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="right-aligned-container">                             
                                
                                <span class="table-badge" id="totalCountDashboard1">0 registros</span>
                            </div>
                        </div>
                    </div>

                <!-- Tabela Dashboard 1 -->
                <div class="table-container">
                    <div class="table-fixed-header-container">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th class="text-end">Valor (R$)</th>
                                    <th class="text-end">% do Total</th>
                                    <th class="text-end">Média Mensal</th>
                                </tr>
                            </thead>
                            <tbody id="resumoTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
            </div>

            <!-- ==================== DASHBOARD 2: EVOLUÇÃO MENSAL ==================== -->
            <div class="tab-pane fade" id="dashboard2" role="tabpanel">
                
                <!-- Filtros Dashboard 2 -->
                <div class="filter-container">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="anoDashboard2" class="form-label filter-label">Ano</label>
                                <select class="form-select" id="anoDashboard2">
                                    <option value="">Selecione</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoriaDashboard2" class="form-label filter-label">Categoria</label>
                                <select class="form-select" id="categoriaDashboard2">
                                    <option value="total">Despesa Total</option>
                                    <option value="bruta">Despesa Bruta</option>
                                    <option value="liquida">Despesa Líquida</option>
                                    <option value="ativo">Pessoal Ativo</option>
                                    <option value="inativo">Inativos/Pensionistas</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex gap-3 flex-wrap">
                                <button class="btn-primary-custom" id="aplicarFiltrosDashboard2">
                                    <span class="material-icons" style="font-size: 14px; margin-right: 6px;">filter_alt</span>
                                    Aplicar Filtros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Evolução -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h4 class="chart-title">Evolução Mensal da Despesa</h4>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="toggleAccumulated">
                                    <label class="form-check-label" for="toggleAccumulated" style="font-size: 12px;">
                                        Acumulado
                                    </label>
                                </div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="chartEvolucao"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ações Dashboard 2 -->
                <div class="actions-container">
                    <div class="export-buttons">
                        <button class="btn-export" id="exportCSVDashboard2">
                            <span class="material-icons" style="font-size: 14px;">file_download</span>
                            Exportar CSV
                        </button>
                        <button class="btn-export" id="printDashboard2">
                            <span class="material-icons" style="font-size: 14px;">print</span>
                            Imprimir
                        </button>
                        <div style="position: relative;">
                            <button class="btn-share" id="shareButton2">
                                <span class="material-icons" style="font-size: 14px;">share</span>
                                Compartilhar
                            </button>
                            <div class="share-options" id="shareOptions2">
                                <a href="#" class="share-option" onclick="copiarLink(); return false;">
                                    <span class="material-icons" style="font-size: 14px;">link</span>
                                    Copiar Link
                                </a>
                                <a href="#" class="share-option" onclick="compartilharFacebook(event);">
                                    <span class="material-icons" style="font-size: 14px;">facebook</span>
                                    Facebook
                                </a>
                                <a href="#" class="share-option" onclick="compartilharTwitter(event);">
                                    <span class="material-icons" style="font-size: 14px;">x</span>
                                    Twitter/X
                                </a>
                                <a href="#" class="share-option" onclick="compartilharLinkedIn(event);">
                                    <span class="material-icons" style="font-size: 14px;">linkedin</span>
                                    LinkedIn
                                </a>
                                <a href="#" class="share-option" onclick="compartilharWhatsApp(event);">
                                    <span class="material-icons" style="font-size: 14px;">chat</span>
                                    WhatsApp
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Evolução Mensal -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Evolução Mensal da Despesa</h3>
                        <span class="table-badge" id="resumoCountDashboard2">0 registros</span>
                    </div>
                    <div class="table-fixed-header-container">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Mês</th>
                                    <th class="text-end">Despesa Bruta</th>
                                    <th class="text-end">Despesa Líquida</th>
                                    <th class="text-end">Pessoal Ativo</th>
                                    <th class="text-end">Inativos/Pensionistas</th>
                                    <th class="text-end">Variação Mês Anterior</th>
                                </tr>
                            </thead>
                            <tbody id="evolucaoTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
            </div>

            <!-- ==================== DASHBOARD 3: LIMITES DA LRF ==================== -->
            <div class="tab-pane fade" id="dashboard3" role="tabpanel">
                
                <!-- Filtros Dashboard 3 -->
                <div class="filter-container">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="periodoLRF" class="form-label filter-label">Período de 12 Meses</label>
                                <select class="form-select" id="periodoLRF">
                                    <option value="">Selecione um período</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Container para limites -->
                <div id="limitesContainer" class="limites-container"></div>

                <!-- Card com limite atual atingido -->
                <div id="limiteAtualContainer" class="limite-atingido-card" style="display: none;">
                    <div class="limite-atingido-title">Limite Atual Atingido</div>
                    <div id="limiteAtualValue" class="limite-atingido-value safe">0.00%</div>
                    <div id="limiteAtualDesc" class="limite-atingido-desc"></div>
                    
                    <div class="limite-progress-container">
                        <div class="progress-limite">
                            <div class="progress-bar-limite" id="progressBarLimiteAtual" style="width: 0%"></div>
                        </div>
                        <div class="limite-progress-labels">
                            <span>0%</span>
                            <span>Limite de Alerta: 44.10%</span>
                            <span>Limite Prudencial: 46.55%</span>
                            <span>Limite Legal: 49.00%</span>
                            <span>100%</span>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Limites -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Apuração do Cumprimento do Limite Legal</h3>
                    </div>
                    <div class="table-fixed-header-container">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th class="text-end">Valor (R$)</th>
                                    <th class="text-end">% sobre a RCL</th>
                                </tr>
                            </thead>
                            <tbody id="limitesTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
            </div>

            <!-- ==================== DASHBOARD 4: DOWNLOADS ==================== -->
            <div class="tab-pane fade" id="dashboard4" role="tabpanel">
                
                <!-- Download por Quadrimestre -->
                <div class="filter-container">
                    <div class="row align-items-end">
                        <div class="col-md-4 col-12">
                            <div class="mb-3">
                                <label for="anoDownload" class="form-label filter-label">Ano</label>
                                <select class="form-select" id="anoDownload">
                                    <option value="">Selecione</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 col-12">
                            <div class="mb-3">
                                <label for="quadrimestreDownload" class="form-label filter-label">Quadrimestre</label>
                                <select class="form-select" id="quadrimestreDownload">
                                    <option value="1">1º Quadrimestre (Jan-Abr)</option>
                                    <option value="2">2º Quadrimestre (Mai-Ago)</option>
                                    <option value="3">3º Quadrimestre (Set-Dez)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 col-12">
                            <button class="btn-primary-custom w-100" id="downloadQuadrimestreCSV">
                                <span class="material-icons" style="font-size: 14px; margin-right: 6px;">download</span>
                                Baixar Quadrimestre
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Cards de Download -->
                <div class="download-grid" id="downloadCardsContainer"></div>

                <!-- Informações sobre os dados -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Informações sobre os Dados</h3>
                    </div>
                    <div class="p-4">
                        <div class="row">
                            <div class="col-md-6 col-12 mb-3">
                                <div class="metric-card">
                                    <span class="material-icons" style="font-size: 32px; color: var(--primary-dark); margin-bottom: 10px;">database</span>
                                    <h4>Fonte dos Dados</h4>
                                    <p class="text-muted" style="font-size: 13px;">Dados atualizados automaticamente do GitHub</p>
                                    <div class="mt-3">
                                        <button class="btn-export w-100" id="atualizarDadosGitHub">
                                            <span class="material-icons" style="font-size: 14px; margin-right: 6px;">sync</span>
                                            Forçar Atualização
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 col-12">
                                <div class="metric-card">
                                    <span class="material-icons" style="font-size: 32px; color: var(--primary-dark); margin-bottom: 10px;">open_in_new</span>
                                    <h4>Portal de Dados Abertos</h4>
                                    <p class="text-muted" style="font-size: 13px;">Acesse o portal oficial de dados abertos de Minas Gerais</p>
                                    <div class="mt-3">
                                        <a href="https://dados.mg.gov.br/" target="_blank" class="btn-export w-100 text-decoration-none">
                                            <span class="material-icons" style="font-size: 14px; margin-right: 6px;">open_in_new</span>
                                            Acessar Portal
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- ==================== SCRIPTS ==================== -->
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==================== VARIÁVEIS GLOBAIS ====================
        let despesaMensalData = [];
        let limitesLRFData = [];
        let dashboardData = { porAno: {}, anos: [], todosDados: [] };
        let chartDistribuicao = null;
        let chartAtivoDetalhado = null;
        let chartEvolucao = null;

        // ==================== FUNÇÕES DE COMPARTILHAMENTO ====================
        function copiarLink() {
            const currentUrl = window.location.href;
            
            navigator.clipboard.writeText(currentUrl).then(() => {
                alert('Link copiado para a área de transferência!');
            }).catch(err => {
                console.error('Erro ao copiar:', err);
                copiarFallback(currentUrl);
            });
            
            document.querySelectorAll('.share-options').forEach(option => {
                option.classList.remove('show');
            });
        }

        function copiarFallback(texto) {
            const textarea = document.createElement('textarea');
            textarea.value = texto;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                alert('Link copiado para a área de transferência!');
            } catch (err) {
                alert('Não foi possível copiar o link. Tente selecionar e copiar manualmente: ' + texto);
            }
            
            document.body.removeChild(textarea);
        }

        function compartilharFacebook(e) {
            e.preventDefault();
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
            
            document.querySelectorAll('.share-options').forEach(option => {
                option.classList.remove('show');
            });
        }

        function compartilharTwitter(e) {
            e.preventDefault();
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent('Dashboard de Despesa com Pessoal - Governo de Minas Gerais');
            window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
            
            document.querySelectorAll('.share-options').forEach(option => {
                option.classList.remove('show');
            });
        }

        function compartilharLinkedIn(e) {
            e.preventDefault();
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank');
            
            document.querySelectorAll('.share-options').forEach(option => {
                option.classList.remove('show');
            });
        }

        function compartilharWhatsApp(e) {
            e.preventDefault();
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent('Confira o dashboard de Despesa com Pessoal do Governo de Minas Gerais');
            window.open(`https://wa.me/?text=${text}%20${url}`, '_blank');
            
            document.querySelectorAll('.share-options').forEach(option => {
                option.classList.remove('show');
            });
        }

        // ==================== FUNÇÕES DE UTILIDADE ====================
        function converterValor(valor) {
            if (!valor || valor === '-' || valor.trim() === '-') return 0;
            
            let valorStr = String(valor).trim();
            valorStr = valorStr.replace(/\./g, '').replace(',', '.');
            valorStr = valorStr.replace(/\s/g, '');
            
            const num = parseFloat(valorStr);
            return isNaN(num) ? 0 : num;
        }
        
        function formatarMoeda(valor) {
            if (valor === undefined || valor === null || valor === 0) return 'R$ 0,00';
            const num = typeof valor === 'string' ? parseFloat(valor) : valor;
            if (isNaN(num)) return 'R$ 0,00';
            return `R$ ${num.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        }
        
        function formatarPorcentagem(valor) {
            if (valor === undefined || valor === null) return '0.00%';
            return `${valor.toFixed(2)}%`;
        }
        
        function formatarMesAno(mesAno) {
            if (!mesAno) return '';
            
            const mesAnoNormalizado = mesAno.includes('-') ? mesAno.replace('-', '_') : mesAno;
            const partes = mesAnoNormalizado.split('_');
            
            if (partes.length >= 2) {
                const mes = partes[0];
                const ano = '20' + partes[1];
                
                const meses = {
                    'jan': 'Jan', 'fev': 'Fev', 'mar': 'Mar', 'abr': 'Abr',
                    'mai': 'Mai', 'jun': 'Jun', 'jul': 'Jul', 'ago': 'Ago',
                    'set': 'Set', 'out': 'Out', 'nov': 'Nov', 'dez': 'Dez'
                };
                
                return `${meses[mes] || mes}/${ano}`;
            }
            return mesAno;
        }
        
        function formatarPeriodoLRF(periodo) {
            if (!periodo) return '';
            
            const partes = periodo.split('_a_');
            if (partes.length === 2) {
                const inicio = formatarMesAno(partes[0]);
                const fim = formatarMesAno(partes[1]);
                return `${inicio} a ${fim}`;
            }
            return periodo.replace(/_/g, '/').replace('a/', ' a ');
        }
        
        function getMesNumero(mesAbrev) {
            const meses = {
                'jan': 1, 'fev': 2, 'mar': 3, 'abr': 4,
                'mai': 5, 'jun': 6, 'jul': 7, 'ago': 8,
                'set': 9, 'out': 10, 'nov': 11, 'dez': 12
            };
            return meses[mesAbrev] || 0;
        }
        
        // ==================== FUNÇÕES DE ATUALIZAÇÃO ====================
        function updateDataAtualizacao() {
            const now = new Date();
            const dataFormatada = now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR');
            const elementoData = document.getElementById('data-atualizacao-header');
            if (elementoData) {
                elementoData.textContent = dataFormatada;
            }
            console.log('Data de atualização definida:', dataFormatada);
        }

        // ==================== FUNÇÕES DE IFRAME ====================
        function removeAllScrollIssues() {
            console.log('Removendo problemas de scroll duplo...');
            
            const elements = [
                document.body,
                document.documentElement,
                document.querySelector('.container-fluid'),
                document.querySelector('.tab-content'),
                ...document.querySelectorAll('.tab-pane'),
                ...document.querySelectorAll('.table-container'),
                ...document.querySelectorAll('.container'),
                ...document.querySelectorAll('.container-fluid')
            ];
            
            elements.forEach(el => {
                if (el && el.style) {
                    el.style.overflowY = 'visible';
                    el.style.overflowX = 'visible';
                    el.style.overflow = 'visible';
                }
            });
            
            document.body.classList.remove('overflow-auto');
            document.documentElement.classList.remove('overflow-auto');
            
            document.documentElement.style.height = 'auto';
            document.body.style.height = 'auto';
        }

        function iframeUpdateHeight() {
            console.log('Atualizando altura do iframe...');
            
            document.body.style.display = 'none';
            document.body.offsetHeight;
            document.body.style.display = '';
            
            const html = document.documentElement;
            const body = document.body;
            
            const scrollHeight = Math.max(
                body.scrollHeight, 
                html.scrollHeight,
                body.offsetHeight, 
                html.offsetHeight
            );
            
            const finalHeight = scrollHeight + 10;
            
            console.log('Altura calculada:', {
                bodyScrollHeight: body.scrollHeight,
                htmlScrollHeight: html.scrollHeight,
                finalHeight: finalHeight
            });
            
            window.parent.postMessage({ 
                iframeHeight: finalHeight 
            }, '*');
            
            return finalHeight;
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
                if (show) {
                    document.body.classList.add('no-scroll');
                } else {
                    document.body.classList.remove('no-scroll');
                }
            }
        }

        // ==================== PROCESSAMENTO DE DADOS ====================
        function processDespesaMensalData(csvData) {
            const processedData = [];
            
            csvData.forEach(row => {
                if (row.unnamed_0 && row.despesa_bruta_com_pessoal_i) {
                    const mesAno = row.unnamed_0;
                    const mesAnoNormalizado = mesAno.replace('-', '_');
                    
                    const despesaBruta = converterValor(row.despesa_bruta_com_pessoal_i);
                    const pessoalAtivo = converterValor(row.pessoal_ativo);
                    const vencimentos = converterValor(row.vencimentos_vantagens_e_outras_despesas_variaveis);
                    const pessoalInativo = converterValor(row.pessoal_inativo_e_pensionistas);
                    const despesaLiquida = converterValor(row.despesa_liquida_com_pessoal_iii_i_ii);
                    const aposentadorias = converterValor(row.aposentadorias_reserva_e_reformas);
                    const pensoes = converterValor(row.pensoes);
                    const obrigacoesPatronais = converterValor(row.obrigacoes_patronais);
                    
                    if (despesaBruta > 0) {
                        processedData.push({
                            MES_ANO: mesAnoNormalizado,
                            MES_ORIGINAL: mesAno,
                            DESPESA_BRUTA: despesaBruta,
                            PESSOAL_ATIVO: pessoalAtivo,
                            VENCIMENTOS: vencimentos,
                            PESSOAL_INATIVO: pessoalInativo,
                            DESPESA_LIQUIDA: despesaLiquida,
                            APOSENTADORIAS: aposentadorias,
                            PENSOES: pensoes,
                            OBRIGACOES_PATRONAIS: obrigacoesPatronais,
                            MES_FORMATADO: formatarMesAno(mesAno),
                            ANO: '20' + mesAno.split('-')[1],
                            MES_NUM: getMesNumero(mesAno.split('-')[0])
                        });
                    }
                }
            });
            
            processedData.sort((a, b) => {
                const [mesA, anoA] = a.MES_ANO.split('_');
                const [mesB, anoB] = b.MES_ANO.split('_');
                const anoNumA = parseInt(anoA);
                const anoNumB = parseInt(anoB);
                
                if (anoNumA !== anoNumB) return anoNumA - anoNumB;
                return getMesNumero(mesA) - getMesNumero(mesB);
            });
            
            return processedData;
        }
        
        function processLimitesLRFData(csvData) {
            const processedLimites = [];
            
            csvData.forEach(row => {
                if (row.unnamed_0) {
                    const limiteMaximo = converterValor(row.limite_maximo_ix_incisos_i_ii_e_iii_art_20_da_lrf_49_00);
                    const limitePrudencial = converterValor(row.limite_prudencial_x_paragrafo_unico_art_22_da_lrf_46_55);
                    const limiteAlerta = converterValor(row.limite_de_alerta_xi_inciso_ii_do_SS_1o_do_art_59_da_lrf_44_10);
                    const despesaTotal = converterValor(row.despesa_total_com_pessoal_dtp_sobre_a_rcl_vii_iii_a_iii_b);
                    const rcl = converterValor(row.receita_corrente_liquida_rcl_iv);
                    const rclAjustada = converterValor(row.receita_corrente_liquida_ajustada_para_calculo_dos_limites_da_despesa_com_pessoal_vii_iv_v_vi);
                    
                    if (limiteMaximo > 0) {
                        processedLimites.push({
                            PERIODO: row.unnamed_0,
                            PERIODO_FORMATADO: formatarPeriodoLRF(row.unnamed_0),
                            LIMITE_MAXIMO: limiteMaximo,
                            LIMITE_PRUDENCIAL: limitePrudencial,
                            LIMITE_ALERTA: limiteAlerta,
                            DESPESA_TOTAL: despesaTotal,
                            RCL: rcl,
                            RCL_AJUSTADA: rclAjustada,
                            PERCENTUAL_UTILIZADO: rclAjustada > 0 ? (despesaTotal / rclAjustada * 100) : 0,
                            PERCENTUAL_LIMITE_LEGAL: limiteMaximo > 0 ? (despesaTotal / limiteMaximo * 100) : 0,
                            PERCENTUAL_LIMITE_PRUDENCIAL: limitePrudencial > 0 ? (despesaTotal / limitePrudencial * 100) : 0,
                            PERCENTUAL_LIMITE_ALERTA: limiteAlerta > 0 ? (despesaTotal / limiteAlerta * 100) : 0
                        });
                    }
                }
            });
            
            processedLimites.sort((a, b) => {
                const fimA = a.PERIODO.split('_a_')[1];
                const fimB = b.PERIODO.split('_a_')[1];
                if (!fimA || !fimB) return 0;
                
                const [mesA, anoA] = fimA.split('_');
                const [mesB, anoB] = fimB.split('_');
                const anoNumA = parseInt('20' + anoA);
                const anoNumB = parseInt('20' + anoB);
                
                if (anoNumA !== anoNumB) return anoNumB - anoNumA;
                return getMesNumero(mesB) - getMesNumero(mesA);
            });
            
            return processedLimites;
        }

        // ==================== CARREGAMENTO DE DADOS ====================
        async function loadCSVData(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    delimiter: ';',
                    skipEmptyLines: true,
                    encoding: 'UTF-8',
                    complete: (results) => resolve(results.data),
                    error: (error) => reject(error)
                });
            });
        }
        
        async function loadDespesaMensalData() {
            try {
                const url = 'https://raw.githubusercontent.com/transparencia-mg/despesa-pessoal-mg/main/dataset/data/despesa_pessoal_mensal.csv';
                const rawData = await loadCSVData(url);
                return processDespesaMensalData(rawData);
            } catch (error) {
                console.error('Erro ao carregar despesa mensal:', error);
                return [];
            }
        }
        
        async function loadLimitesLRFData() {
            try {
                const url = 'https://raw.githubusercontent.com/transparencia-mg/despesa-pessoal-mg/main/dataset/data/limites_lrf.csv';
                const rawData = await loadCSVData(url);
                return processLimitesLRFData(rawData);
            } catch (error) {
                console.error('Erro ao carregar limites LRF:', error);
                return [];
            }
        }
        
        async function loadAvailableFiles() {
            try {
                const url = 'https://api.github.com/repos/transparencia-mg/despesa-pessoal-mg/contents/dataset/data';
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                const files = await response.json();
                return files.filter(file => file.name.endsWith('.csv')).map(file => ({
                    name: file.name,
                    url: file.download_url,
                    size: file.size,
                    type: file.type
                }));
            } catch (error) {
                console.error('Erro ao carregar lista de arquivos:', error);
                return [];
            }
        }
        
        function processDashboardData() {
            const dadosPorAno = {};
            
            despesaMensalData.forEach(item => {
                const ano = item.ANO;
                if (!dadosPorAno[ano]) dadosPorAno[ano] = [];
                dadosPorAno[ano].push(item);
            });
            
            const anosOrdenados = Object.keys(dadosPorAno).sort((a, b) => b - a);
            
            anosOrdenados.forEach(ano => {
                const dadosAno = dadosPorAno[ano];
                const totalAno = dadosAno.reduce((sum, item) => sum + item.DESPESA_BRUTA, 0);
                const mediaAnual = totalAno / dadosAno.length;
                
                dadosAno.sort((a, b) => a.MES_NUM - b.MES_NUM);
                
                dadosPorAno[ano] = {
                    dados: dadosAno,
                    total: totalAno,
                    media: mediaAnual,
                    ultimoMes: dadosAno[dadosAno.length - 1],
                    meses: dadosAno.length
                };
            });
            
            dashboardData = {
                porAno: dadosPorAno,
                anos: anosOrdenados,
                todosDados: despesaMensalData
            };
        }
        
        async function loadAllData() {
            showLoading(true);
            
            try {
                const [despesaData, limitesData, availableFiles] = await Promise.all([
                    loadDespesaMensalData(),
                    loadLimitesLRFData(),
                    loadAvailableFiles()
                ]);
                
                despesaMensalData = despesaData;
                limitesLRFData = limitesData;
                
                processDashboardData();
                updateFilterOptions();
                updateDashboard1();
                updateDashboard2();
                updateDashboard3();
                updateDownloadCards(availableFiles);
                updateDataAtualizacao();
                
                removeAllScrollIssues();
                setTimeout(iframeUpdateHeight, 500);
                
                showLoading(false);
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                showLoading(false);
                alert("Erro ao carregar dados. Verifique o console para mais detalhes.");
            }
        }

        // ==================== ATUALIZAÇÃO DE FILTROS ====================
        function updateFilterOptions() {
            // Dashboard 1
            const anoSelect1 = document.getElementById('anoDashboard1');
            const mesSelect1 = document.getElementById('mesDashboard1');
            
            anoSelect1.innerHTML = '<option value="">Selecione</option>';
            mesSelect1.innerHTML = '<option value="">Selecione</option>';
            
            if (dashboardData.anos && dashboardData.anos.length > 0) {
                const anosOrdenados = [...dashboardData.anos].sort((a, b) => b - a);
                anosOrdenados.forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    anoSelect1.appendChild(option);
                });
                
                if (anosOrdenados.length > 0) {
                    anoSelect1.value = anosOrdenados[0];
                    
                    const dadosAno = dashboardData.porAno[anosOrdenados[0]]?.dados || [];
                    const mesesUnicos = [...new Set(dadosAno.map(item => item.MES_NUM))].sort((a, b) => a - b);
                    
                    const nomesMeses = {
                        1: 'Janeiro', 2: 'Fevereiro', 3: 'Março', 4: 'Abril',
                        5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
                        9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
                    };
                    
                    mesesUnicos.forEach(mesNum => {
                        const option = document.createElement('option');
                        option.value = mesNum;
                        option.textContent = nomesMeses[mesNum] || `Mês ${mesNum}`;
                        mesSelect1.appendChild(option);
                    });
                    
                    if (mesesUnicos.length > 0) {
                        mesSelect1.value = mesesUnicos[mesesUnicos.length - 1];
                    }
                }
            }
            
            anoSelect1.addEventListener('change', function() {
                const anoSelecionado = this.value;
                mesSelect1.innerHTML = '<option value="">Selecione</option>';
                
                if (anoSelecionado && dashboardData.porAno[anoSelecionado]) {
                    const dadosAno = dashboardData.porAno[anoSelecionado].dados;
                    const mesesUnicos = [...new Set(dadosAno.map(item => item.MES_NUM))].sort((a, b) => a - b);
                    
                    const nomesMeses = {
                        1: 'Janeiro', 2: 'Fevereiro', 3: 'Março', 4: 'Abril',
                        5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
                        9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
                    };
                    
                    mesesUnicos.forEach(mesNum => {
                        const option = document.createElement('option');
                        option.value = mesNum;
                        option.textContent = nomesMeses[mesNum] || `Mês ${mesNum}`;
                        mesSelect1.appendChild(option);
                    });
                    
                    if (mesesUnicos.length > 0) {
                        mesSelect1.value = mesesUnicos[mesesUnicos.length - 1];
                    }
                }
                
                updateDashboard1();
            });
            
            // Dashboard 2
            const anoSelect2 = document.getElementById('anoDashboard2');
            anoSelect2.innerHTML = '<option value="">Selecione</option>';
            
            if (dashboardData.anos && dashboardData.anos.length > 0) {
                const anosOrdenados = [...dashboardData.anos].sort((a, b) => b - a);
                anosOrdenados.forEach((ano, index) => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    if (index === 0) option.selected = true;
                    anoSelect2.appendChild(option);
                });
            }
            
            // Dashboard 3
            const periodoLRFSelect = document.getElementById('periodoLRF');
            periodoLRFSelect.innerHTML = '<option value="">Selecione um período</option>';
            
            if (limitesLRFData && limitesLRFData.length > 0) {
                limitesLRFData.forEach(limite => {
                    const option = document.createElement('option');
                    option.value = limite.PERIODO;
                    option.textContent = limite.PERIODO_FORMATADO;
                    periodoLRFSelect.appendChild(option);
                });
                
                if (limitesLRFData.length > 0) {
                    periodoLRFSelect.value = limitesLRFData[0].PERIODO;
                }
            }
            
            // Dashboard 4
            const anoDownloadSelect = document.getElementById('anoDownload');
            anoDownloadSelect.innerHTML = '<option value="">Selecione</option>';
            
            if (dashboardData.anos && dashboardData.anos.length > 0) {
                dashboardData.anos.sort((a, b) => b - a).forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    anoDownloadSelect.appendChild(option);
                });
            }
        }

        // ==================== DASHBOARD 1 ====================
        function updateDashboard1() {
            const anoSelecionado = document.getElementById('anoDashboard1')?.value || '';
            const mesSelecionado = document.getElementById('mesDashboard1')?.value || '';
            
            let dadosFiltrados = [];
            
            if (anoSelecionado && dashboardData.porAno[anoSelecionado]) {
                dadosFiltrados = dashboardData.porAno[anoSelecionado].dados || [];
            } else {
                dadosFiltrados = [...dashboardData.todosDados];
            }
            
            if (mesSelecionado) {
                const mesNum = parseInt(mesSelecionado);
                dadosFiltrados = dadosFiltrados.filter(item => item.MES_NUM === mesNum);
            }
            
            updateSummaryCards(dadosFiltrados);
            updateChartDistribuicao(dadosFiltrados);
            updateChartAtivoDetalhado(dadosFiltrados);
            updateResumoTable(dadosFiltrados);
        }
        
        function updateSummaryCards(dados) {
            const summaryCards = document.getElementById('summaryCards');
            if (!summaryCards) return;
            
            summaryCards.innerHTML = '';
            
            if (dados.length === 0) {
                summaryCards.innerHTML = '<div class="col-12 text-center"><p class="text-muted">Nenhum dado disponível</p></div>';
                return;
            }
            
            const ultimoMes = dados[dados.length - 1];
            const totalAno = dados.reduce((sum, item) => sum + item.DESPESA_BRUTA, 0);
            const mediaMensal = totalAno / dados.length;
            
            let variacaoMensal = 0;
            if (dados.length >= 2) {
                const mesAnterior = dados[dados.length - 2];
                if (mesAnterior && mesAnterior.DESPESA_BRUTA > 0) {
                    variacaoMensal = ((ultimoMes.DESPESA_BRUTA - mesAnterior.DESPESA_BRUTA) / mesAnterior.DESPESA_BRUTA * 100);
                }
            }
            
            let variacaoAnual = 0;
            const anoAtual = ultimoMes.ANO;
            const anoAnterior = (parseInt(anoAtual) - 1).toString();
            
            if (dashboardData.porAno[anoAnterior]) {
                const totalAnoAnterior = dashboardData.porAno[anoAnterior].total;
                const mediaAnoAnterior = totalAnoAnterior / dashboardData.porAno[anoAnterior].dados.length;
                if (mediaAnoAnterior > 0) {
                    variacaoAnual = ((mediaMensal - mediaAnoAnterior) / mediaAnoAnterior * 100);
                }
            }
            
            const cards = [
                {
                    title: 'Despesa Bruta Atual',
                    value: formatarMoeda(ultimoMes.DESPESA_BRUTA),
                    change: variacaoMensal,
                    changeLabel: 'vs mês anterior'
                },
                {
                    title: 'Média Mensal',
                    value: formatarMoeda(mediaMensal),
                    change: variacaoAnual,
                    changeLabel: 'vs ano anterior'
                },
                {
                    title: 'Pessoal Ativo',
                    value: formatarMoeda(ultimoMes.PESSOAL_ATIVO),
                    percentage: (ultimoMes.PESSOAL_ATIVO / ultimoMes.DESPESA_BRUTA * 100).toFixed(1) + '%'
                },
                {
                    title: 'Inativos/Pensionistas',
                    value: formatarMoeda(ultimoMes.PESSOAL_INATIVO),
                    percentage: (ultimoMes.PESSOAL_INATIVO / ultimoMes.DESPESA_BRUTA * 100).toFixed(1) + '%'
                }
            ];
            
            cards.forEach(card => {
                const changeClass = card.change > 0 ? 'danger' : (card.change < 0 ? 'positive' : 'warning');
                const changeSign = card.change > 0 ? '+' : '';
                
                const cardHTML = `
                    <div class="col-md-3 col-6">
                        <div class="metric-card">
                            <div class="metric-label">${card.title}</div>
                            <div class="metric-value">${card.value}</div>
                            ${card.percentage ? `
                                <div class="metric-change ${parseFloat(card.percentage) > 50 ? 'warning' : 'positive'}">
                                    ${card.percentage} do total
                                </div>
                            ` : `
                                <div class="metric-change ${changeClass}">
                                    ${changeSign}${card.change ? card.change.toFixed(1) + '%' : '0%'} ${card.changeLabel || ''}
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
                summaryCards.innerHTML += cardHTML;
            });
        }
        
        function updateChartDistribuicao(dados) {
            const canvas = document.getElementById('chartDistribuicao');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (chartDistribuicao) chartDistribuicao.destroy();
            
            const ultimoMes = dados[dados.length - 1];
            if (!ultimoMes) return;
            
            const labels = ['Pessoal Ativo', 'Inativos/Pensionistas', 'Outras Despesas'];
            const values = [
                ultimoMes.PESSOAL_ATIVO,
                ultimoMes.PESSOAL_INATIVO,
                ultimoMes.DESPESA_BRUTA - ultimoMes.PESSOAL_ATIVO - ultimoMes.PESSOAL_INATIVO
            ];
            const backgroundColor = ['#2F5D8A', '#A8323A', '#6C7A89'];
            
            chartDistribuicao = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor, borderWidth: 1, borderColor: '#fff' }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.raw;
                                    const total = values.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                    return `${context.label}: ${formatarMoeda(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateChartAtivoDetalhado(dados) {
            const canvas = document.getElementById('chartAtivoDetalhado');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (chartAtivoDetalhado) chartAtivoDetalhado.destroy();
            
            const dadosPorAno = {};
            dados.forEach(item => {
                if (!dadosPorAno[item.ANO]) dadosPorAno[item.ANO] = [];
                dadosPorAno[item.ANO].push(item);
            });
            
            const anos = Object.keys(dadosPorAno).sort();
            const labels = anos;
            const ativoData = anos.map(ano => {
                const dadosAno = dadosPorAno[ano];
                return dadosAno.reduce((sum, item) => sum + item.PESSOAL_ATIVO, 0) / dadosAno.length;
            });
            const inativoData = anos.map(ano => {
                const dadosAno = dadosPorAno[ano];
                return dadosAno.reduce((sum, item) => sum + item.PESSOAL_INATIVO, 0) / dadosAno.length;
            });
            
            chartAtivoDetalhado = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Pessoal Ativo (Média)', data: ativoData, backgroundColor: 'rgba(47, 93, 138, 0.7)', borderColor: '#2F5D8A', borderWidth: 1 },
                        { label: 'Inativos/Pensionistas (Média)', data: inativoData, backgroundColor: 'rgba(168, 50, 58, 0.7)', borderColor: '#A8323A', borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: (value) => formatarMoeda(value) }
                        }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${formatarMoeda(context.raw)}`
                            }
                        }
                    }
                }
            });
        }
        
        function updateResumoTable(dados) {
            const tableBody = document.getElementById('resumoTableBody');
            const resumoCount = document.getElementById('resumoCountDashboard1');
            if (!tableBody || !resumoCount) return;
            
            tableBody.innerHTML = '';
            
            if (dados.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhum dado disponível</td></tr>';
                resumoCount.textContent = '0 registros';
                return;
            }
            
            const ultimoMes = dados[dados.length - 1];
            const totalBruto = ultimoMes.DESPESA_BRUTA;
            
            const categorias = [
                { nome: 'Despesa Bruta com Pessoal', valor: ultimoMes.DESPESA_BRUTA },
                { nome: 'Pessoal Ativo', valor: ultimoMes.PESSOAL_ATIVO },
                { nome: 'Vencimentos e Vantagens', valor: ultimoMes.VENCIMENTOS },
                { nome: 'Obrigações Patronais', valor: ultimoMes.OBRIGACOES_PATRONAIS },
                { nome: 'Inativos e Pensionistas', valor: ultimoMes.PESSOAL_INATIVO },
                { nome: 'Aposentadorias', valor: ultimoMes.APOSENTADORIAS },
                { nome: 'Pensões', valor: ultimoMes.PENSOES },
                { nome: 'Despesa Líquida com Pessoal', valor: ultimoMes.DESPESA_LIQUIDA }
            ];
            
            categorias.forEach(categoria => {
                const porcentagem = totalBruto > 0 ? (categoria.valor / totalBruto * 100) : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${categoria.nome}</td>
                    <td class="text-end valor-monetario">${formatarMoeda(categoria.valor)}</td>
                    <td class="text-end">${porcentagem.toFixed(1)}%</td>
                    <td class="text-end">${formatarMoeda(categoria.valor / 12)}</td>
                `;
                tableBody.appendChild(row);
            });
            
            resumoCount.textContent = `${dados.length} registros`;
        }

        // ==================== DASHBOARD 2 ====================
        function updateDashboard2() {
            const anoSelecionado = document.getElementById('anoDashboard2')?.value || '';
            const categoriaSelecionada = document.getElementById('categoriaDashboard2')?.value || 'total';
            
            let dadosFiltrados = [];
            
            if (anoSelecionado && dashboardData.porAno[anoSelecionado]) {
                dadosFiltrados = dashboardData.porAno[anoSelecionado].dados || [];
            } else {
                dadosFiltrados = [...dashboardData.todosDados];
            }
            
            updateChartEvolucao(dadosFiltrados, categoriaSelecionada);
            updateEvolucaoTable(dadosFiltrados);
        }
        
        function updateChartEvolucao(dados, categoria) {
            const canvas = document.getElementById('chartEvolucao');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            if (chartEvolucao) chartEvolucao.destroy();
            
            const labels = dados.map(item => item.MES_FORMATADO);
            let data = [];
            
            switch(categoria) {
                case 'total': case 'bruta': data = dados.map(item => item.DESPESA_BRUTA); break;
                case 'liquida': data = dados.map(item => item.DESPESA_LIQUIDA); break;
                case 'ativo': data = dados.map(item => item.PESSOAL_ATIVO); break;
                case 'inativo': data = dados.map(item => item.PESSOAL_INATIVO); break;
            }
            
            const toggleAccumulated = document.getElementById('toggleAccumulated')?.checked || false;
            let finalData = data;
            let datasetLabel = '';
            
            switch(categoria) {
                case 'total': datasetLabel = toggleAccumulated ? 'Despesa Total Acumulada' : 'Despesa Total'; break;
                case 'bruta': datasetLabel = toggleAccumulated ? 'Despesa Bruta Acumulada' : 'Despesa Bruta'; break;
                case 'liquida': datasetLabel = toggleAccumulated ? 'Despesa Líquida Acumulada' : 'Despesa Líquida'; break;
                case 'ativo': datasetLabel = toggleAccumulated ? 'Pessoal Ativo Acumulado' : 'Pessoal Ativo'; break;
                case 'inativo': datasetLabel = toggleAccumulated ? 'Inativos/Pensionistas Acumulado' : 'Inativos/Pensionistas'; break;
            }
            
            if (toggleAccumulated) {
                finalData = [];
                let acumulado = 0;
                data.forEach(valor => {
                    acumulado += valor;
                    finalData.push(acumulado);
                });
            }
            
            chartEvolucao = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: datasetLabel,
                        data: finalData,
                        borderColor: '#29435A',
                        backgroundColor: 'rgba(41, 67, 90, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: !toggleAccumulated,
                            ticks: { callback: (value) => formatarMoeda(value) }
                        }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${formatarMoeda(context.raw)}`
                            }
                        }
                    }
                }
            });
        }
        
        function updateEvolucaoTable(dados) {
            const tableBody = document.getElementById('evolucaoTableBody');
            const resumoCount = document.getElementById('resumoCountDashboard2');
            if (!tableBody || !resumoCount) return;
            
            tableBody.innerHTML = '';
            
            if (dados.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum dado disponível</td></tr>';
                resumoCount.textContent = '0 registros';
                return;
            }
            
            dados.forEach((item, index) => {
                let variacao = '--';
                if (index > 0) {
                    const mesAnterior = dados[index - 1];
                    if (mesAnterior && mesAnterior.DESPESA_BRUTA > 0) {
                        const variacaoValor = ((item.DESPESA_BRUTA - mesAnterior.DESPESA_BRUTA) / mesAnterior.DESPESA_BRUTA * 100);
                        variacao = `${variacaoValor.toFixed(1)}%`;
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.MES_FORMATADO}</strong></td>
                    <td class="text-end valor-monetario">${formatarMoeda(item.DESPESA_BRUTA)}</td>
                    <td class="text-end valor-monetario">${formatarMoeda(item.DESPESA_LIQUIDA)}</td>
                    <td class="text-end valor-monetario">${formatarMoeda(item.PESSOAL_ATIVO)}</td>
                    <td class="text-end valor-monetario">${formatarMoeda(item.PESSOAL_INATIVO)}</td>
                    <td class="text-end ${variacao.includes('-') ? 'valor-positivo' : 'valor-negativo'}">${variacao}</td>
                `;
                tableBody.appendChild(row);
            });
            
            resumoCount.textContent = `${dados.length} registros`;
        }

        // ==================== DASHBOARD 3: LIMITES DA LRF ====================
        function updateDashboard3() {
            const periodoSelecionado = document.getElementById('periodoLRF')?.value || '';
            
            const container = document.getElementById('limitesContainer');
            if (container) container.innerHTML = '';
            
            const limiteAtualContainer = document.getElementById('limiteAtualContainer');
            if (limiteAtualContainer) limiteAtualContainer.style.display = 'none';
            
            if (!periodoSelecionado || limitesLRFData.length === 0) {
                updateLimitesTable(null);
                return;
            }
            
            const limite = limitesLRFData.find(l => l.PERIODO === periodoSelecionado);
            if (limite) {
                createLimiteCard(limite, container);
                updateLimiteAtualCard(limite);
                updateLimitesTable(limite);
            } else {
                updateLimitesTable(null);
            }
        }
        
        function createLimiteCard(limite, container) {
            let statusClass = 'safe';
            let statusText = 'Dentro do Limite';
            
            if (limite.PERCENTUAL_UTILIZADO >= 90) {
                statusClass = 'danger';
                statusText = 'Crítico';
            } else if (limite.PERCENTUAL_UTILIZADO >= 80) {
                statusClass = 'warning';
                statusText = 'Atenção';
            }
            
            const cardHTML = `
                <div class="limite-info-card">
                    <div class="limite-periodo">${limite.PERIODO_FORMATADO}</div>
                    <div class="limite-dados">
                        <div class="limite-item">
                            <div class="limite-item-label">LIMITE LEGAL</div>
                            <div class="limite-item-value">${formatarMoeda(limite.LIMITE_MAXIMO)}</div>
                            <div class="limite-item-percentual ${limite.PERCENTUAL_LIMITE_LEGAL >= 90 ? 'danger' : limite.PERCENTUAL_LIMITE_LEGAL >= 80 ? 'warning' : 'safe'}">
                                ${limite.PERCENTUAL_LIMITE_LEGAL.toFixed(2)}%
                            </div>
                        </div>
                        <div class="limite-item">
                            <div class="limite-item-label">LIMITE PRUDENCIAL</div>
                            <div class="limite-item-value">${formatarMoeda(limite.LIMITE_PRUDENCIAL)}</div>
                            <div class="limite-item-percentual ${limite.PERCENTUAL_LIMITE_PRUDENCIAL >= 90 ? 'danger' : limite.PERCENTUAL_LIMITE_PRUDENCIAL >= 80 ? 'warning' : 'safe'}">
                                ${limite.PERCENTUAL_LIMITE_PRUDENCIAL.toFixed(2)}%
                            </div>
                        </div>
                        <div class="limite-item">
                            <div class="limite-item-label">LIMITE DE ALERTA</div>
                            <div class="limite-item-value">${formatarMoeda(limite.LIMITE_ALERTA)}</div>
                            <div class="limite-item-percentual ${limite.PERCENTUAL_LIMITE_ALERTA >= 90 ? 'danger' : limite.PERCENTUAL_LIMITE_ALERTA >= 80 ? 'warning' : 'safe'}">
                                ${limite.PERCENTUAL_LIMITE_ALERTA.toFixed(2)}%
                            </div>
                        </div>
                        <div class="limite-item">
                            <div class="limite-item-label">DESPESA EXECUTADA</div>
                            <div class="limite-item-value">${formatarMoeda(limite.DESPESA_TOTAL)}</div>
                            <div class="limite-item-percentual ${statusClass}">
                                ${limite.PERCENTUAL_UTILIZADO.toFixed(2)}% (${statusText})
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="limite-item">
                            <div class="limite-item-label">RCL AJUSTADA</div>
                            <div class="limite-item-value">${formatarMoeda(limite.RCL_AJUSTADA)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML += cardHTML;
        }
        
        function updateLimiteAtualCard(limite) {
            const container = document.getElementById('limiteAtualContainer');
            const valorElement = document.getElementById('limiteAtualValue');
            const descElement = document.getElementById('limiteAtualDesc');
            const progressBar = document.getElementById('progressBarLimiteAtual');
            
            if (!container || !limite) return;
            
            let statusClass = 'safe';
            let statusText = 'Dentro do Limite';
            let statusDesc = 'A despesa está dentro dos limites estabelecidos pela LRF.';
            
            if (limite.PERCENTUAL_UTILIZADO >= 90) {
                statusClass = 'danger';
                statusText = 'LIMITE CRÍTICO';
                statusDesc = 'A despesa ultrapassou 90% do limite legal. Ação imediata necessária.';
            } else if (limite.PERCENTUAL_UTILIZADO >= 80) {
                statusClass = 'warning';
                statusText = 'ATENÇÃO';
                statusDesc = 'A despesa está entre 80-90% do limite legal. Monitoramento necessário.';
            }
            
            valorElement.textContent = `${limite.PERCENTUAL_UTILIZADO.toFixed(2)}%`;
            valorElement.className = `limite-atingido-value ${statusClass}`;
            descElement.textContent = `${statusText} - ${statusDesc}`;
            
            const progressWidth = Math.min(100, limite.PERCENTUAL_UTILIZADO);
            progressBar.style.width = `${progressWidth}%`;
            progressBar.className = `progress-bar-limite ${statusClass}`;
            
            container.style.display = 'block';
        }
        
        function updateLimitesTable(limite) {
            const tableBody = document.getElementById('limitesTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (!limite) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Selecione um período para visualizar os dados</td></tr>';
                return;
            }
            
            const linhas = [
                { descricao: 'Receita Corrente Líquida (RCL)', valor: limite.RCL, percentual: 100.00 },
                { descricao: 'Receita Corrente Líquida Ajustada', valor: limite.RCL_AJUSTADA, percentual: 100.00 },
                { descricao: 'Despesa Total com Pessoal (DTP)', valor: limite.DESPESA_TOTAL, percentual: limite.PERCENTUAL_UTILIZADO },
                { descricao: 'Limite de Alerta (44.10% da RCL)', valor: limite.LIMITE_ALERTA, percentual: 44.10 },
                { descricao: 'Limite Prudencial (46.55% da RCL)', valor: limite.LIMITE_PRUDENCIAL, percentual: 46.55 },
                { descricao: 'Limite Legal (49.00% da RCL)', valor: limite.LIMITE_MAXIMO, percentual: 49.00 }
            ];
            
            linhas.forEach(linha => {
                const row = document.createElement('tr');
                const percentualClass = linha.percentual >= 90 ? 'valor-negativo' : 
                                      linha.percentual >= 80 ? 'valor-negativo' : 'valor-positivo';
                
                row.innerHTML = `
                    <td>${linha.descricao}</td>
                    <td class="text-end valor-monetario">${formatarMoeda(linha.valor)}</td>
                    <td class="text-end ${percentualClass}">${linha.percentual.toFixed(2)}%</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // ==================== DASHBOARD 4: DOWNLOADS ====================
        function updateDownloadCards(files) {
            const container = document.getElementById('downloadCardsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            const fileMetadata = {
                'despesa_pessoal_mensal.csv': {
                    description: 'Dados mensais de despesa com pessoal do Estado de Minas Gerais'
                },
                'limites_lrf.csv': {
                    description: 'Limites da Lei de Responsabilidade Fiscal por período de 12 meses'
                }
            };
            
            const groupedFiles = { despesa: [], limites: [] };
            
            files.forEach(file => {
                if (file.name.includes('despesa')) groupedFiles.despesa.push(file);
                else if (file.name.includes('limites')) groupedFiles.limites.push(file);
            });
            
            [...groupedFiles.despesa, ...groupedFiles.limites].forEach(file => {
                const metadata = fileMetadata[file.name] || { description: 'Arquivo de dados' };
                const sizeInKB = (file.size / 1024).toFixed(2);
                
                const cardHTML = `
                    <div class="download-card">
                        <div class="download-card-title">
                            <span class="material-icons" style="font-size: 20px; margin-right: 8px; color: var(--accent-red);">insert_drive_file</span>
                            ${file.name}
                        </div>
                        <div class="download-card-desc">${metadata.description}</div>
                        <div class="download-card-info">
                            <span class="material-icons" style="font-size: 14px;">storage</span>
                            Tamanho: ${sizeInKB} KB
                        </div>
                        <button class="btn-export w-100" onclick="downloadFile('${file.url}', '${file.name}')">
                            <span class="material-icons" style="font-size: 14px; margin-right: 6px;">download</span>
                            Baixar Arquivo
                        </button>
                    </div>
                `;
                container.innerHTML += cardHTML;
            });
            
            if (files.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">Nenhum arquivo disponível para download no momento.</div></div>';
            }
        }
        
        window.downloadFile = function(url, fileName) {
            showLoading(true);
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                    return response.blob();
                })
                .then(blob => {
                    const link = document.createElement('a');
                    const objectUrl = URL.createObjectURL(blob);
                    link.href = objectUrl;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        URL.revokeObjectURL(objectUrl);
                        document.body.removeChild(link);
                        showLoading(false);
                    }, 100);
                })
                .catch(error => {
                    console.error('Erro ao baixar arquivo:', error);
                    alert('Erro ao baixar o arquivo. Por favor, tente novamente.');
                    showLoading(false);
                });
        };

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // Dashboard 1
            document.getElementById('aplicarFiltros')?.addEventListener('click', updateDashboard1);
            document.getElementById('limparFiltros')?.addEventListener('click', function() {
                const anoSelect = document.getElementById('anoDashboard1');
                const mesSelect = document.getElementById('mesDashboard1');
                if (anoSelect && dashboardData.anos.length > 0) anoSelect.value = dashboardData.anos[0];
                if (mesSelect && dashboardData.porAno[dashboardData.anos[0]]) {
                    const dadosAno = dashboardData.porAno[dashboardData.anos[0]].dados;
                    const mesesUnicos = [...new Set(dadosAno.map(item => item.MES_NUM))].sort((a, b) => a - b);
                    if (mesesUnicos.length > 0) mesSelect.value = mesesUnicos[mesesUnicos.length - 1];
                }
                updateDashboard1();
            });
            
            document.getElementById('exportCSVDashboard1')?.addEventListener('click', exportDashboard1CSV);
            document.getElementById('printDashboard1')?.addEventListener('click', () => window.print());
            
            // Dashboard 2
            document.getElementById('aplicarFiltrosDashboard2')?.addEventListener('click', updateDashboard2);
            document.getElementById('categoriaDashboard2')?.addEventListener('change', updateDashboard2);
            document.getElementById('toggleAccumulated')?.addEventListener('change', updateDashboard2);
            document.getElementById('exportCSVDashboard2')?.addEventListener('click', exportDashboard2CSV);
            document.getElementById('printDashboard2')?.addEventListener('click', () => window.print());
            
            // Dashboard 3
            document.getElementById('periodoLRF')?.addEventListener('change', updateDashboard3);
            
            // Dashboard 4
            document.getElementById('atualizarDadosGitHub')?.addEventListener('click', loadAllData);
            document.getElementById('downloadQuadrimestreCSV')?.addEventListener('click', downloadQuadrimestre);
            
            // Share buttons
            document.getElementById('shareButton1')?.addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('shareOptions1').classList.toggle('show');
            });
            
            document.getElementById('shareButton2')?.addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('shareOptions2').classList.toggle('show');
            });
            
            document.addEventListener('click', function() {
                document.querySelectorAll('.share-options').forEach(option => {
                    option.classList.remove('show');
                });
            });
        }
        
        function exportDashboard1CSV() {
            const anoSelecionado = document.getElementById('anoDashboard1')?.value || '';
            const mesSelecionado = document.getElementById('mesDashboard1')?.value || '';
            
            let dadosFiltrados = [];
            if (anoSelecionado && dashboardData.porAno[anoSelecionado]) {
                dadosFiltrados = dashboardData.porAno[anoSelecionado].dados || [];
            } else {
                dadosFiltrados = [...dashboardData.todosDados];
            }
            
            if (mesSelecionado) {
                const mesNum = parseInt(mesSelecionado);
                dadosFiltrados = dadosFiltrados.filter(item => item.MES_NUM === mesNum);
            }
            
            if (dadosFiltrados.length === 0) {
                alert('Não há dados para exportar.');
                return;
            }
            
            let csvContent = 'Mês;Despesa Bruta;Pessoal Ativo;Vencimentos;Obrigações Patronais;Inativos/Pensionistas;Aposentadorias;Pensões;Despesa Líquida\n';
            
            dadosFiltrados.forEach(item => {
                csvContent += `${item.MES_FORMATADO};${item.DESPESA_BRUTA};${item.PESSOAL_ATIVO};${item.VENCIMENTOS};${item.OBRIGACOES_PATRONAIS};${item.PESSOAL_INATIVO};${item.APOSENTADORIAS};${item.PENSOES};${item.DESPESA_LIQUIDA}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'despesa_pessoal_resumo.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`CSV exportado com sucesso! ${dadosFiltrados.length} registros exportados.`);
        }
        
        function exportDashboard2CSV() {
            const anoSelecionado = document.getElementById('anoDashboard2')?.value || '';
            
            let dadosFiltrados = [];
            if (anoSelecionado && dashboardData.porAno[anoSelecionado]) {
                dadosFiltrados = dashboardData.porAno[anoSelecionado].dados || [];
            } else {
                dadosFiltrados = [...dashboardData.todosDados];
            }
            
            if (dadosFiltrados.length === 0) {
                alert('Não há dados para exportar.');
                return;
            }
            
            let csvContent = 'Mês;Despesa Bruta;Despesa Líquida;Pessoal Ativo;Inativos/Pensionistas;Variação Mês Anterior\n';
            
            dadosFiltrados.forEach((item, index) => {
                let variacao = 0;
                if (index > 0) {
                    const mesAnterior = dadosFiltrados[index - 1];
                    if (mesAnterior && mesAnterior.DESPESA_BRUTA > 0) {
                        variacao = ((item.DESPESA_BRUTA - mesAnterior.DESPESA_BRUTA) / mesAnterior.DESPESA_BRUTA * 100);
                    }
                }
                
                csvContent += `${item.MES_FORMATADO};${item.DESPESA_BRUTA};${item.DESPESA_LIQUIDA};${item.PESSOAL_ATIVO};${item.PESSOAL_INATIVO};${variacao.toFixed(1)}%\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'despesa_pessoal_evolucao.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`CSV exportado com sucesso! ${dadosFiltrados.length} registros exportados.`);
        }
        
        function downloadQuadrimestre() {
            const ano = document.getElementById('anoDownload')?.value || '';
            const quadrimestre = document.getElementById('quadrimestreDownload')?.value || '1';
            
            if (!ano) {
                alert('Por favor, selecione um ano.');
                return;
            }
            
            let meses = [];
            switch(quadrimestre) {
                case '1': meses = [1, 2, 3, 4]; break;
                case '2': meses = [5, 6, 7, 8]; break;
                case '3': meses = [9, 10, 11, 12]; break;
            }
            
            const dadosFiltrados = despesaMensalData.filter(item => 
                item.ANO === ano && meses.includes(item.MES_NUM)
            );
            
            if (dadosFiltrados.length === 0) {
                alert('Não há dados para o período selecionado.');
                return;
            }
            
            let csvContent = 'Mês;Despesa Bruta;Pessoal Ativo;Inativos/Pensionistas;Despesa Líquida\n';
            
            dadosFiltrados.forEach(item => {
                csvContent += `${item.MES_FORMATADO};${item.DESPESA_BRUTA};${item.PESSOAL_ATIVO};${item.PESSOAL_INATIVO};${item.DESPESA_LIQUIDA}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `despesa_pessoal_${ano}_quadrimestre_${quadrimestre}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`CSV baixado com sucesso! ${dadosFiltrados.length} registros exportados.`);
        }

        // ==================== INICIALIZAÇÃO ====================
        document.addEventListener('DOMContentLoaded', function() {
            updateDataAtualizacao();
            setupEventListeners();
            loadAllData();
            
            // Atualizar altura do iframe após carregamento completo
            window.addEventListener('load', function() {
                setTimeout(() => {
                    removeAllScrollIssues();
                    iframeUpdateHeight();
                }, 500);
            });
        });
    </script>
</body>
</html>
